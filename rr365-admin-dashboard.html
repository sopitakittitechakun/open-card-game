<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RR365 • Admin Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{ --bg:#0b0e16; --card:#141b2c; --primary:#ffd700; --text:#e9f0ff; --muted:#9db0da; }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--text); font-family:'Sarabun',sans-serif; }
  .wrap{ max-width:1180px; margin:26px auto; padding:0 16px; }
  h1{ margin:0 0 16px; color:var(--primary); font-size:26px; }
  .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
  .card{ background:var(--card); border:1px solid rgba(255,215,0,.16); border-radius:14px; padding:14px; box-shadow:0 8px 28px rgba(0,0,0,.35); }
  .kpi{ font-size:13px; color:var(--muted); }
  .kpi b{ display:block; font-size:30px; color:var(--primary); margin-top:6px; }
  .row{ display:flex; gap:12px; margin-top:12px; }
  .row .card{ flex:1; }
  input,button,select{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,215,0,.25); background:#0f1627; color:var(--text); }
  input::placeholder{ color:#7e93be }
  button{ background:linear-gradient(90deg,#ffd700,#ff9900); color:#2b1600; border:none; cursor:pointer; font-weight:700; }
  table{ width:100%; border-collapse:collapse; font-size:13px; }
  th,td{ padding:8px 10px; border-bottom:1px dashed rgba(255,215,0,.15); text-align:left; }
  .tag{ background:#22c55e; color:#0b2a0f; font-weight:700; padding:2px 8px; border-radius:999px; font-size:12px; }
  .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .muted{ color:var(--muted); font-size:13px }
  .err{ background:#7f1d1d; border:1px solid #ef4444; color:#fff; padding:8px 10px; border-radius:10px; font-size:13px; display:none; }
  /* Login */
  .login{ max-width:520px; margin:10vh auto; padding:20px; background:var(--card); border:1px solid rgba(255,215,0,.18); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.45);}
  .login h2{ margin:0 0 10px; color:var(--primary) }
  .login .g{ display:grid; gap:10px; }
  .right{ text-align:right }
  .split{ display:flex; gap:8px }
  @media (max-width:900px){ .grid{grid-template-columns:1fr} .row{flex-direction:column} }
</style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="loginView" class="login" style="display:none;">
  <h2>เข้าสู่ระบบ • RR365 Admin</h2>
  <div class="g">
    <label>API Base URL (Web App ของ Apps Script)
      <input id="apiBase" placeholder="เช่น https://script.google.com/macros/s/xxx/exec">
    </label>
    <label>Admin Token
      <input id="adminToken" placeholder="วาง ADMIN_TOKEN ที่ตั้งใน Script Properties">
    </label>
    <label class="split">
      <span><input type="checkbox" id="remember"> จำค่าไว้ในเครื่องนี้</span>
      <span class="muted" style="margin-left:auto;">* เก็บใน session/localStorage</span>
    </label>
    <div class="right">
      <button id="btnLogin">เข้าสู่ระบบ</button>
    </div>
    <div id="loginErr" class="err"></div>
  </div>
</div>

<!-- APP VIEW -->
<div id="appView" style="display:none;">
  <div class="wrap">
    <div class="topbar">
      <h1>RR365 • Admin Dashboard</h1>
      <div>
        <span id="curApi" class="muted"></span>
        <button id="btnRefresh" style="margin-left:8px;background:#334155;color:#e5e7eb;border:1px solid #475569;">รีเฟรช</button>
        <button id="btnLogout" style="margin-left:8px;">ออกจากระบบ</button>
      </div>
    </div>

    <div id="appErr" class="err"></div>

    <div class="grid">
      <div class="card kpi">เล่นวันนี้<b id="kpi-plays">0</b></div>
      <div class="card kpi">ได้เลข <span id="winNum">-</span> วันนี้<b id="kpi-wins">0</b></div>
      <div class="card kpi">อัตราชนะวันนี้<b id="kpi-rate">0%</b></div>
    </div>

    <div class="row">
      <div class="card">
        <div class="muted" style="margin-bottom:6px;">จำนวนการเล่นรายชั่วโมง (วันนี้)</div>
        <canvas id="chartHour" height="140"></canvas>
      </div>
      <div class="card">
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="q" placeholder="ค้นหา: วันที่(yyyy-mm-dd)/เบอร์(มาสก์)/โค้ด/เลขที่ได้" style="flex:1">
          <button id="btnSearch">ค้นหา</button>
        </div>
        <div style="max-height:260px; overflow:auto;">
          <table id="tblSearch"><thead><tr><th>เวลา</th><th>เบอร์</th><th>เลข</th><th>โค้ด</th><th>สถานะ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="topbar">
        <div style="font-weight:700;">ล่าสุด 50 รายการ</div>
        <div>
          <input id="exportDate" type="date">
          <button id="btnExport">Export CSV</button>
        </div>
      </div>
      <div style="max-height:360px; overflow:auto;">
        <table id="tblLatest"><thead><tr><th>เวลา</th><th>เบอร์</th><th>เลข</th><th>โค้ด</th><th>สถานะ</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- จัดการโค้ด -->
    <div class="card" style="margin-top:12px;">
      <div class="topbar">
        <div style="font-weight:700;">จัดการโค้ด</div>
        <div class="muted">สร้างโค้ดเดี่ยว / สร้างชุด / เปิด–ปิดการใช้งาน</div>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px;">
        <div style="flex:1; min-width:260px;">
          <div class="muted" style="margin-bottom:6px;">สร้างโค้ดเดี่ยว</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <input id="codeManual" placeholder="ระบุโค้ดเอง (ว่าง=สุ่ม)">
            <input id="codePrefix" placeholder="Prefix" value="RR" style="width:120px">
            <input id="codeLen" placeholder="ความยาวสุ่ม" value="8" style="width:120px">
            <input id="codeMax" placeholder="จำนวนใช้ได้ (เช่น 1)" value="1" style="width:150px">
            <input id="codeExp" type="datetime-local" style="width:220px">
            <input id="codeOwner" placeholder="ผู้รับผิดชอบ" style="width:180px">
            <input id="codeNote" placeholder="หมายเหตุ" style="width:220px">
            <button id="btnCreateCode">สร้างโค้ด</button>
          </div>
        </div>

        <div style="flex:1; min-width:260px;">
          <div class="muted" style="margin-bottom:6px;">สร้างโค้ดเป็นชุด</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <input id="bulkPrefix" placeholder="Prefix" value="RR" style="width:120px">
            <input id="bulkLen" placeholder="ความยาวสุ่ม" value="8" style="width:120px">
            <input id="bulkCount" placeholder="จำนวน (<=500)" value="50" style="width:140px">
            <input id="bulkMax" placeholder="ใช้ได้/โค้ด" value="1" style="width:160px">
            <input id="bulkExp" type="datetime-local" style="width:220px">
            <input id="bulkOwner" placeholder="ผู้รับผิดชอบ" style="width:180px">
            <input id="bulkNote" placeholder="หมายเหตุ" style="width:220px">
            <button id="btnBulkCode">สร้างชุด</button>
          </div>
        </div>
      </div>

      <div style="max-height:360px; overflow:auto;">
        <table id="tblCodes">
          <thead>
            <tr><th>โค้ด</th><th>สถานะ</th><th>ใช้/ได้</th><th>หมดอายุ</th><th>Owner</th><th>Note</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------- Session & Login ---------- */
const SKEY = 'rr365_admin_cfg';
function getCfg(){ const s = sessionStorage.getItem(SKEY) || localStorage.getItem(SKEY); try{ return s? JSON.parse(s): null; }catch{ return null; } }
function setCfg(obj, remember){ const s = JSON.stringify(obj||{}); sessionStorage.setItem(SKEY, s); if(remember) localStorage.setItem(SKEY, s); else localStorage.removeItem(SKEY); }
function showLogin(){ document.getElementById('loginView').style.display='block'; document.getElementById('appView').style.display='none'; }
function showApp(){ document.getElementById('loginView').style.display='none'; document.getElementById('appView').style.display='block'; }

document.getElementById('btnLogin').onclick = async ()=>{
  const api = document.getElementById('apiBase').value.trim();
  const tok = document.getElementById('adminToken').value.trim();
  const remember = document.getElementById('remember').checked;
  const err = document.getElementById('loginErr');
  err.style.display='none';
  if(!api || !tok){ err.textContent='กรอก API Base และ Admin Token ให้ครบ'; err.style.display='block'; return; }
  setCfg({api, tok}, remember);
  try{ await loadStats(); await loadCodes(); document.getElementById('curApi').textContent = api; showApp(); }
  catch(e){ err.textContent='เข้าระบบไม่สำเร็จ: โปรดตรวจ API/Token'; err.style.display='block'; sessionStorage.removeItem(SKEY); localStorage.removeItem(SKEY); }
};
document.getElementById('btnLogout').onclick = ()=>{ sessionStorage.removeItem(SKEY); localStorage.removeItem(SKEY); showLogin(); };
document.getElementById('btnRefresh').onclick = ()=>{ loadStats().catch(()=>{}); loadCodes().catch(()=>{}); };

/* ---------- API helper ---------- */
async function api(path, params={}){
  const cfg = getCfg(); if(!cfg) throw new Error('NO_CFG');
  const url = new URL(cfg.api);
  url.searchParams.set('mode', path);
  for(const [k,v] of Object.entries(params)) url.searchParams.set(k, v);
  const res = await fetch(url.toString(), { headers:{ 'Authorization':'Bearer '+cfg.tok }, cache:'no-store', credentials:'omit' });
  if(path==='admin_export_csv') return res; // จะได้ Blob
  const ct = (res.headers.get('content-type')||'').toLowerCase();
  if(!ct.includes('application/json')) throw new Error('BAD_RESPONSE');
  const data = await res.json();
  if(data && data.error === 'UNAUTHORIZED') throw new Error('UNAUTH');
  return data;
}
function fmt(d){ const t=new Date(d); return t.toLocaleString('th-TH'); }
function showErr(msg){ const el = document.getElementById('appErr'); el.textContent = msg; el.style.display = msg? 'block':'none'; }

/* ---------- UI rendering ---------- */
let chartHour;
function renderHourChart(perHour){
  const labels = [...Array(24)].map((_,i)=> String(i).padStart(2,'0')+':00');
  const data = labels.map((_,i)=> Number(perHour[String(i).padStart(2,'0')]||0));
  if(chartHour) chartHour.destroy();
  chartHour = new Chart(document.getElementById('chartHour'), {
    type:'bar', data:{ labels, datasets:[{ label:'เล่นต่อชั่วโมง', data }] },
    options:{ plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });
}
function fillTable(tbody, items){
  tbody.innerHTML='';
  items.forEach(it=>{
    const tr = document.createElement('tr');
    const iso = (new Date(it.ts)).toISOString();
    tr.innerHTML = `
      <td>${fmt(it.ts||it.date)}</td>
      <td>${it.phone}</td>
      <td>${it.reward}</td>
      <td>${it.code||''}</td>
      <td>${it.claimed?'<span class="tag">เคลมแล้ว</span>':'-'}</td>
      <td><button data-ts="${iso}" data-claimed="${!it.claimed}">${it.claimed?'ยกเลิกเคลม':'มาร์กเคลม'}</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-ts]').forEach(btn=>{
    btn.onclick = async ()=>{
      btn.disabled=true;
      try{
        const ts = btn.getAttribute('data-ts');
        const claimed = btn.getAttribute('data-claimed')==='true';
        const res = await api('admin_mark_claim', { ts, claimed });
        if(res.ok){ await loadStats(); if(document.getElementById('q').value) await doSearch(); }
      } finally { btn.disabled=false; }
    };
  });
}

/* ---------- Actions (Stats/Search/Export) ---------- */
async function loadStats(){
  showErr('');
  const res = await api('admin_stats');
  if(!res.ok) throw new Error('STATS_FAIL');
  document.getElementById('kpi-plays').textContent = res.todayPlays;
  document.getElementById('kpi-wins').textContent  = res.todayWins;
  document.getElementById('kpi-rate').textContent  = (res.todayPlays? (res.todayWins*100/res.todayPlays):0).toFixed(1)+'%';
  document.getElementById('winNum').textContent    = res.winNumber;
  renderHourChart(res.perHour||{});
  fillTable(document.querySelector('#tblLatest tbody'), res.latest||[]);
}
async function doSearch(){
  showErr('');
  const q = document.getElementById('q').value.trim();
  const res = await api('admin_search', { q });
  if(res.ok) fillTable(document.querySelector('#tblSearch tbody'), res.items||[]);
}
document.getElementById('btnSearch').onclick = doSearch;

document.getElementById('btnExport').onclick = async ()=>{
  showErr('');
  try{
    const d = document.getElementById('exportDate').value || new Date().toISOString().slice(0,10);
    const res = await api('admin_export_csv', { date: d });
    const blob = await res.blob();
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`plays_${d}.csv`; a.click();
  }catch(e){ showErr('Export ไม่สำเร็จ'); }
};

/* ---------- Codes Management ---------- */
async function apiCodesList(){ return api('admin_codes_list'); }
async function apiCodeCreate({code,prefix,len,max_uses,expires,owner,note}){
  const params = { code, prefix, len, max_uses, owner, note }; if(expires) params.expires = expires; return api('admin_codes_create', params);
}
async function apiCodeBulk({prefix,len,count,max_uses,expires,owner,note}){
  const params = { prefix, len, count, max_uses, owner, note }; if(expires) params.expires = expires; return api('admin_codes_bulk', params);
}
async function apiCodeToggle({code,active}){ return api('admin_codes_toggle', { code, active }); }

function fillCodesTable(items){
  const tb = document.querySelector('#tblCodes tbody'); tb.innerHTML='';
  items.forEach(it=>{
    const tr = document.createElement('tr');
    const exp = it.expires ? new Date(it.expires).toLocaleString('th-TH') : '-';
    tr.innerHTML = `
      <td style="font-weight:700">${it.code}</td>
      <td>${it.active?'<span class="tag">ใช้งาน</span>':'-'}</td>
      <td>${it.uses}/${it.max_uses}</td>
      <td>${exp}</td>
      <td>${it.owner||'-'}</td>
      <td>${it.note||'-'}</td>
      <td>
        <button data-act="toggle" data-code="${it.code}" data-next="${!it.active}">${it.active?'ปิดใช้งาน':'เปิดใช้งาน'}</button>
        <button data-act="copy" data-code="${it.code}">คัดลอก</button>
      </td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-act="toggle"]').forEach(btn=>{
    btn.onclick = async ()=>{
      btn.disabled = true;
      try{
        await apiCodeToggle({ code: btn.getAttribute('data-code'), active: btn.getAttribute('data-next')==='true' });
        await loadCodes();
      } finally { btn.disabled = false; }
    };
  });
  tb.querySelectorAll('button[data-act="copy"]').forEach(btn=>{
    btn.onclick = async ()=>{
      await navigator.clipboard.writeText(btn.getAttribute('data-code'));
      btn.textContent = 'คัดลอกแล้ว'; setTimeout(()=>btn.textContent='คัดลอก',1200);
    };
  });
}

async function loadCodes(){
  showErr('');
  const r = await apiCodesList();
  if(r.ok) fillCodesTable(r.items||[]);
}

document.getElementById('btnCreateCode').onclick = async ()=>{
  showErr('');
  const code  = document.getElementById('codeManual').value.trim().toUpperCase();
  const prefix= document.getElementById('codePrefix').value.trim();
  const len   = document.getElementById('codeLen').value.trim();
  const maxU  = document.getElementById('codeMax').value.trim();
  const exp   = document.getElementById('codeExp').value ? new Date(document.getElementById('codeExp').value).toISOString() : '';
  const owner = document.getElementById('codeOwner').value.trim();
  const note  = document.getElementById('codeNote').value.trim();

  const res = await apiCodeCreate({ code, prefix, len, max_uses:maxU, expires:exp, owner, note });
  if(!res.ok){ showErr(res.error||'สร้างโค้ดไม่สำเร็จ'); return; }
  document.getElementById('codeManual').value='';
  await loadCodes();
  alert('สร้างโค้ดสำเร็จ: '+res.code);
};

document.getElementById('btnBulkCode').onclick = async ()=>{
  showErr('');
  const prefix= document.getElementById('bulkPrefix').value.trim();
  const len   = document.getElementById('bulkLen').value.trim();
  const count = document.getElementById('bulkCount').value.trim();
  const maxU  = document.getElementById('bulkMax').value.trim();
  const exp   = document.getElementById('bulkExp').value ? new Date(document.getElementById('bulkExp').value).toISOString() : '';
  const owner = document.getElementById('bulkOwner').value.trim();
  const note  = document.getElementById('bulkNote').value.trim();

  const res = await apiCodeBulk({ prefix, len, count, max_uses:maxU, expires:exp, owner, note });
  if(!res.ok){ showErr(res.error||'สร้างชุดโค้ดไม่สำเร็จ'); return; }
  await loadCodes();
  alert(`สร้างโค้ดสำเร็จ ${res.count} รายการ`);
};

/* ---------- Boot ---------- */
async function boot(){
  const cfg = getCfg();
  if(!cfg){ showLogin(); return; }
  document.getElementById('curApi').textContent = cfg.api;
  try{
    await loadStats();
    await loadCodes();
    showApp();
    setInterval(loadStats, 30000);
  }catch(e){
    showErr('โหลดข้อมูลไม่สำเร็จ: โปรดตรวจ API/Token'); showLogin();
  }
}
window.addEventListener('DOMContentLoaded', ()=>{
  const cfg = getCfg(); if(cfg){ document.getElementById('apiBase').value = cfg.api; }
  boot();
});
</script>
</body>
</html>
