<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RR365 Admin Dashboard</title>
<style>
  body{font-family:system-ui;background:#0b0b0b;color:#fff;margin:0;padding:18px}
  .wrap{max-width:1000px;margin:0 auto}
  .card{background:#141414;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px;margin-bottom:12px}
  h1{font-size:20px;margin:0 0 10px}
  input,select{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f0f0f;color:#fff}
  button{padding:10px 14px;border-radius:12px;border:0;background:#ff2b2b;color:#fff;font-weight:700;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .msg{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);display:none;white-space:pre-line}
  .ok{border-color:rgba(0,255,140,.25)} .err{border-color:rgba(255,60,60,.35)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px;text-align:left;vertical-align:top;font-size:13px}
  th{opacity:.85}
  .muted{opacity:.7;font-size:12px}
  .chip{display:inline-block;padding:2px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;font-size:12px;opacity:.9}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>üõ°Ô∏è RR365 Admin Dashboard</h1>
    <div class="row">
      <label class="muted">SCRIPT /exec</label>
      <input id="scriptUrl" style="min-width:360px;flex:1" placeholder="https://script.google.com/macros/s/AKfycbzIlBX_qzwM74IG8SEys2m6vS3p6VRno2iEs1uR5t-S6YcZR1iyDOSjvHsCF4B4QDWY/exec">
      <label class="muted">Admin Key</label>
      <input id="adminKey" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
      <select id="type">
        <option value="participants">participants (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</option>
        <option value="logs">logs (‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î/‡∏ã‡πâ‡∏≥)</option>
      </select>
      <select id="limit">
        <option value="30">30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
        <option value="50" selected>50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
        <option value="100">100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
        <option value="200">200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
      </select>
      <button id="btnLoad">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div id="msg" class="msg"></div>
    <div class="muted" style="margin-top:8px">
      *‡πÉ‡∏™‡πà SCRIPT_URL ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (LocalStorage)
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div><span class="chip" id="badge">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î</span></div>
      <div class="muted" id="count"></div>
    </div>
    <div id="tableWrap"></div>
  </div>

</div>

<script>
  const $scriptUrl = document.getElementById("scriptUrl");
  const $adminKey  = document.getElementById("adminKey");
  const $type      = document.getElementById("type");
  const $limit     = document.getElementById("limit");
  const $btnLoad   = document.getElementById("btnLoad");
  const $msg       = document.getElementById("msg");
  const $tableWrap = document.getElementById("tableWrap");
  const $badge     = document.getElementById("badge");
  const $count     = document.getElementById("count");

  $scriptUrl.value = localStorage.getItem("rr_admin_script") || "";
  $type.value      = localStorage.getItem("rr_admin_type") || "participants";
  $limit.value     = localStorage.getItem("rr_admin_limit") || "50";

  function show(text, type="ok"){
    $msg.style.display="block";
    $msg.className="msg "+(type==="err"?"err":"ok");
    $msg.textContent=text;
  }
  function hideMsg(){ $msg.style.display="none"; }

  function jsonp(url, params){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      params.jsonp = "1";
      params.callback = cb;
      params._ts = Date.now().toString();

      const full = url + "?" + new URLSearchParams(params).toString();

      const s = document.createElement("script");
      s.src = full; s.async = true;

      const t = setTimeout(()=>{ cleanup(); reject(new Error("TIMEOUT")); }, 12000);

      window[cb] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
      s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("LOAD_ERROR")); };

      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }

      document.body.appendChild(s);
    });
  }

  function escapeHtml(v){
    return String(v??"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderTable(type, rows){
    if(!rows || !rows.length){
      $tableWrap.innerHTML = "<div class='muted' style='padding:12px'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>";
      return;
    }

    if(type === "participants"){
      const head = `
        <table>
          <thead><tr>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>ua_key</th><th>device_id</th><th>fingerprint</th><th>note</th>
          </tr></thead><tbody>`;
      const body = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.created_at)}</td>
          <td><b>${escapeHtml(String(r.phone||""))}</b></td>
          <td>${escapeHtml(r.ua_key)}</td>
          <td>${escapeHtml(r.device_id)}</td>
          <td>${escapeHtml(r.fingerprint)}</td>
          <td>${escapeHtml(r.note)}</td>
        </tr>
      `).join("");
      $tableWrap.innerHTML = head + body + "</tbody></table>";
      return;
    }

    const head = `
      <table>
        <thead><tr>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>action</th><th>phone_raw</th><th>phone_norm</th><th>result</th><th>message</th>
        </tr></thead><tbody>`;
    const body = rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.ts)}</td>
        <td>${escapeHtml(r.action)}</td>
        <td><b>${escapeHtml(r.phone_raw)}</b></td>
        <td>${escapeHtml(r.phone_normalized)}</td>
        <td>${escapeHtml(r.result)}</td>
        <td>${escapeHtml(r.message)}</td>
      </tr>
    `).join("");
    $tableWrap.innerHTML = head + body + "</tbody></table>";
  }

  $btnLoad.addEventListener("click", async ()=>{
    hideMsg();
    $btnLoad.disabled = true;

    const url = $scriptUrl.value.trim();
    const key = $adminKey.value.trim();
    const type = $type.value;
    const limit = $limit.value;

    localStorage.setItem("rr_admin_script", url);
    localStorage.setItem("rr_admin_type", type);
    localStorage.setItem("rr_admin_limit", limit);

    if(!/\/exec(\?|$)/.test(url)){
      show("SCRIPT URL ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec", "err");
      $btnLoad.disabled = false;
      return;
    }
    if(!key){
      show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Admin Key", "err");
      $btnLoad.disabled = false;
      return;
    }

    try{
      const data = await jsonp(url, {
        action: "admin_list",
        admin_key: key,
        type,
        limit
      });

      if(!data || !data.ok){
        show((data && data.msg) ? data.msg : "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "err");
        $badge.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        $btnLoad.disabled = false;
        return;
      }

      $badge.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + type;
      $count.textContent = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: " + (data.rows ? data.rows.length : 0);
      renderTable(type, data.rows || []);
      show("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "ok");
    }catch(e){
      show("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Anyone / ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏¥‡∏î / Deploy ‡∏ú‡∏¥‡∏î‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô)", "err");
      $badge.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    }finally{
      $btnLoad.disabled = false;
    }
  });
</script>
</body>
</html>
