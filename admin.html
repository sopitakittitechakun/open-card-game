<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</title>
<style>
  body{font-family:system-ui;background:#0b0b0b;color:#fff;padding:20px;margin:0}
  .wrap{max-width:1100px;margin:0 auto}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#101010;color:#fff;padding:10px 12px;font-size:14px}
  button{border:0;background:#ff2b2b;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:14px;background:#141414}
  th,td{padding:10px;border:1px solid rgba(255,255,255,.1);font-size:13px;vertical-align:top}
  th{background:#1f1f1f;text-align:left}
  tr:nth-child(even){background:#101010}
  .hint{opacity:.8;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üìã Admin: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</h1>

  <div class="row">
    <input id="key" placeholder="admin_key" style="min-width:220px">
    <button id="btnLoad" type="button">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå" style="flex:1;min-width:240px">
  </div>

  <div id="count" class="hint"></div>

  <table>
    <thead>
      <tr>
        <th style="width:60px">#</th>
        <th style="width:190px">‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th style="width:130px">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
        <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
        <th style="width:240px">device_id</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGtkm3t8WpKizvfo23weEh85Wk0TmdSrdsy4mYFG60kOHaqj8y03ElkSgAiY8xLkR4XA/exec";

  const tb = document.getElementById("tb");
  const count = document.getElementById("count");
  const q = document.getElementById("q");
  const key = document.getElementById("key");
  const btnLoad = document.getElementById("btnLoad");

  let allRows = [];

  function fmt(v){ try{return new Date(v).toLocaleString("th-TH")}catch(e){return String(v||"")} }

  function render(){
    const kw = (q.value||"").replace(/\D/g,"").trim();
    const rows = kw ? allRows.filter(r => String(r.phone||"").includes(kw)) : allRows;

    count.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ‡πÅ‡∏™‡∏î‡∏á ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map((r,i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${fmt(r.created_at)}</td>
        <td>${r.phone||""}</td>
        <td style="word-break:break-word">${r.user_agent||""}</td>
        <td style="word-break:break-word">${r.device_id||""}</td>
      </tr>
    `).join("");
  }

  function jsonpRequest(params){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      params.jsonp = "1";
      params.callback = cbName;

      const qs = new URLSearchParams(params).toString();
      const url = SCRIPT_URL + "?" + qs;

      const script = document.createElement("script");
      script.src = url;
      script.async = true;

      window[cbName] = (data)=>{ cleanup(); resolve(data); };
      script.onerror = ()=>{ cleanup(); reject(new Error("JSONP error")); };

      function cleanup(){
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      document.body.appendChild(script);
      setTimeout(()=>{ try{ cleanup(); }catch(e){} reject(new Error("timeout")); }, 12000);
    });
  }

  async function loadData(){
    btnLoad.disabled = true;
    tb.innerHTML = `<tr><td colspan="5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

    try{
      const data = await jsonpRequest({ action:"admin_list", admin_key: key.value });

      if(!data || !data.ok){
        tb.innerHTML = `<tr><td colspan="5">${(data && data.msg) || "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"}</td></tr>`;
        return;
      }

      allRows = data.rows || [];
      render();
    }catch(e){
      tb.innerHTML = `<tr><td colspan="5">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
    }finally{
      btnLoad.disabled = false;
    }
  }

  btnLoad.addEventListener("click", loadData);
  q.addEventListener("input", render);
</script>
</body>
</html>
