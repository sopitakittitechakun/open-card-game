<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{
    --txt:#fff; --muted:rgba(255,255,255,.72);
    --line:rgba(255,255,255,.12); --line2:rgba(255,43,43,.28);
    --red:#ff2b2b; --red2:#b80000;
    --bg1:rgba(255,43,43,.18); --bg2:rgba(255,255,255,.06);
    --r:18px; --r2:22px;
    --shadow:0 18px 60px rgba(0,0,0,.55);
    --shadow2:0 14px 40px rgba(0,0,0,.50);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;color:var(--txt);background:transparent}
  .wrap{padding:14px}
  .hero{border-radius:var(--r2);padding:14px;border:1px solid var(--line);
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    box-shadow:var(--shadow);position:relative;overflow:hidden}
  .hero:before{content:"";position:absolute;inset:-1px;
    background:radial-gradient(520px 190px at 25% 0%, rgba(255,43,43,.30), transparent 60%);
    opacity:.85;pointer-events:none}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;position:relative}
  .brand{display:flex;gap:10px;align-items:flex-start}
  .logo{width:38px;height:38px;border-radius:14px;background:linear-gradient(135deg,var(--red),var(--red2));
    border:1px solid rgba(255,255,255,.16);display:grid;place-items:center;font-weight:1000}
  .h1{font-weight:1000;font-size:15px;margin:0}
  .sub{color:var(--muted);font-size:12px;margin-top:3px;line-height:1.45}
  .pill{display:flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--line);
    background:rgba(0,0,0,.22);color:var(--muted);font-size:12px;white-space:nowrap}
  .dot{width:8px;height:8px;border-radius:999px;background:#19ff8a;box-shadow:0 0 0 4px rgba(25,255,138,.12)}
  .dot.err{background:var(--red);box-shadow:0 0 0 4px rgba(255,43,43,.12)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .box{padding:12px;border-radius:var(--r);border:1px solid var(--line);background:rgba(0,0,0,.18);box-shadow:var(--shadow2)}
  .k{color:var(--muted);font-size:12px}
  .n{font-size:22px;font-weight:1000;margin-top:6px}
  .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
  .tab{padding:10px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.80);font-weight:1000;font-size:12px;cursor:pointer}
  .tab.active{color:#fff;border-color:var(--line2);
    background:linear-gradient(135deg,rgba(255,43,43,.22),rgba(0,0,0,.22))}
  .panel{margin-top:12px;border-radius:var(--r2);border:1px solid var(--line);background:rgba(0,0,0,.26);
    box-shadow:var(--shadow);overflow:hidden}
  .ph{padding:12px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:space-between}
  .pt{font-weight:1000;font-size:13px}
  .chip{font-size:11px;font-weight:1000;color:rgba(255,255,255,.78);border:1px solid var(--line);
    padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06)}
  .pb{padding:12px}
  label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
  input{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.42);color:#fff;outline:none}
  .btns{display:flex;gap:10px;margin-top:10px}
  button{width:100%;padding:12px;border-radius:14px;border:0;font-weight:1000;cursor:pointer}
  .p{background:linear-gradient(135deg,var(--red),var(--red2));color:#fff}
  .g{background:rgba(255,255,255,.08);color:#fff;border:1px solid var(--line)}
  .w{background:linear-gradient(135deg,rgba(255,204,102,.18),rgba(0,0,0,.20));color:#fff;border:1px solid rgba(255,204,102,.35)}
  .msg{display:none;margin-top:10px;padding:12px;border-radius:14px;border:1px solid var(--line);
    background:rgba(255,255,255,.06);white-space:pre-line;font-size:12px;line-height:1.55}
  .msg.ok{border-color:rgba(25,255,138,.28)}
  .msg.err{border-color:rgba(255,43,43,.32)}
  .card{margin-top:10px;padding:12px;border-radius:var(--r);border:1px solid var(--line);background:rgba(0,0,0,.18)}
  .ct{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .ttl{font-weight:1000;font-size:12px}
  .bdg{font-size:11px;font-weight:1000;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:rgba(255,255,255,.78)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .lines{margin-top:8px;color:var(--muted);font-size:12px;white-space:pre-line;line-height:1.55}
  .raw{margin-top:10px;padding:10px;border-radius:14px;border:1px dashed rgba(255,255,255,.18);
    background:rgba(0,0,0,.25);color:rgba(255,255,255,.75);font-size:11px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="row">
      <div class="brand">
        <div class="logo">R</div>
        <div>
          <div class="h1">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365</div>
          <div class="sub">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å (participants + logs)</div>
        </div>
      </div>
      <div class="pill"><span class="dot" id="dot"></span><span id="st">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶</span></div>
    </div>

    <div class="grid">
      <div class="box"><div class="k">participants (‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤)</div><div class="n" id="cP">-</div></div>
      <div class="box"><div class="k">logs (‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤)</div><div class="n" id="cL">-</div></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="p">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
      <button class="tab" data-tab="l">üßæ logs</button>
      <button class="tab" data-tab="u">üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</button>
    </div>
  </div>

  <div class="panel" id="panel-p">
    <div class="ph"><div class="pt">üë• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</div><span class="chip">LIST</span></div>
    <div class="pb">
      <label>ADMIN_KEY</label>
      <input id="key1" value="RR365">

      <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö): ‡πÄ‡∏ö‡∏≠‡∏£‡πå / ua_key / device_id / fingerprint</label>
      <input id="q1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0611111111 ‡∏´‡∏£‡∏∑‡∏≠ ua_xxx ‡∏´‡∏£‡∏∑‡∏≠ dev_xxx ‡∏´‡∏£‡∏∑‡∏≠ fp_xxx">

      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
      <input id="limit1" value="50" inputmode="numeric">

      <div class="btns">
        <button class="p" id="btnP">‡πÇ‡∏´‡∏•‡∏î/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button class="g" id="btnPClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>

      <div class="btns">
        <button class="g" id="btnPing">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (PING)</button>
        <button class="g" id="btnTest">‡∏ó‡∏î‡∏™‡∏≠‡∏ö LIST ‡∏î‡∏¥‡∏ö</button>
      </div>

      <div class="msg" id="msgP"></div>
      <div id="listP"></div>
      <div class="raw" id="rawP" style="display:none"></div>
    </div>
  </div>

  <div class="panel" id="panel-l" style="display:none">
    <div class="ph"><div class="pt">üßæ logs</div><span class="chip">LIST</span></div>
    <div class="pb">
      <label>ADMIN_KEY</label>
      <input id="key2" value="RR365">

      <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö): ‡πÄ‡∏ö‡∏≠‡∏£‡πå / fp / ua_key / action / result</label>
      <input id="q2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0611111111 ‡∏´‡∏£‡∏∑‡∏≠ fp_xxx ‡∏´‡∏£‡∏∑‡∏≠ RATE_LIMIT">

      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
      <input id="limit2" value="50" inputmode="numeric">

      <div class="btns">
        <button class="p" id="btnL">‡πÇ‡∏´‡∏•‡∏î/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button class="g" id="btnLClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>

      <div class="msg" id="msgL"></div>
      <div id="listL"></div>
      <div class="raw" id="rawL" style="display:none"></div>
    </div>
  </div>

  <div class="panel" id="panel-u" style="display:none">
    <div class="ph"><div class="pt">üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å (‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô participants)</div><span class="chip">UNLOCK</span></div>
    <div class="pb">
      <label>ADMIN_KEY</label>
      <input id="key3" value="RR365">

      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</label>
      <input id="uphone" placeholder="0611111111" inputmode="numeric">

      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
      <input id="unote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏•‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÄ‡∏Ñ‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©">

      <div class="btns">
        <button class="w" id="btnU">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</button>
        <button class="g" id="btnUClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>

      <div class="msg" id="msgU"></div>
    </div>
  </div>
</div>

<script>
  function $(id){ return document.getElementById(id); }
  function setStatus(t, ok){
    $("st").textContent = t;
    $("dot").className = "dot" + (ok ? "" : " err");
  }
  function showMsg(id, t, type){
    const el=$(id); el.style.display="block";
    el.className="msg " + (type==="err" ? "err":"ok");
    el.textContent=t;
  }
  function hideMsg(id){ const el=$(id); el.style.display="none"; el.textContent=""; }
  function showRaw(id, obj){
    const el=$(id);
    el.style.display="block";
    el.textContent = "RAW RESPONSE:\n" + (obj===undefined ? "undefined" : JSON.stringify(obj, null, 2));
  }
  function hideRaw(id){ const el=$(id); el.style.display="none"; el.textContent=""; }
  function esc(s){
    s = (s===null || s===undefined) ? "" : String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function card(title, badge, lines){
    return '<div class="card"><div class="ct"><div class="ttl">'+esc(title)+'</div><span class="bdg">'+esc(badge)+'</span></div><div class="lines mono">'+esc(lines||"")+'</div></div>';
  }

  Array.prototype.forEach.call(document.querySelectorAll(".tab"), function(b){
    b.addEventListener("click", function(){
      Array.prototype.forEach.call(document.querySelectorAll(".tab"), x=>x.classList.remove("active"));
      b.classList.add("active");
      const t=b.getAttribute("data-tab");
      $("panel-p").style.display = (t==="p") ? "" : "none";
      $("panel-l").style.display = (t==="l") ? "" : "none";
      $("panel-u").style.display = (t==="u") ? "" : "none";
    });
  });

  function keyAll(){
    const k = $("key1").value || $("key2").value || $("key3").value || "";
    $("key1").value = k; $("key2").value = k; $("key3").value = k;
    return k.trim();
  }

  function ping(){
    hideMsg("msgP"); hideRaw("rawP");
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶", true);
    google.script.run
      .withSuccessHandler(function(res){
        showRaw("rawP", res);
        if(!res || !res.ok){
          setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
          showMsg("msgP", (res && res.msg) ? res.msg : "PING: res ‡∏ß‡πà‡∏≤‡∏á/undefined", "err");
          return;
        }
        setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
        showMsg("msgP", "PING_OK\nparticipants: "+res.counts.participants+"\nlogs: "+res.counts.logs, "ok");
      })
      .withFailureHandler(function(err){
        setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
        showMsg("msgP", "PING CALL FAIL: " + (err && err.message ? err.message : err), "err");
      })
      .rr365Admin_ping();
  }

  function loadParticipants(){
    hideMsg("msgP"); hideRaw("rawP");
    const key = keyAll();
    const q = $("q1").value.trim();
    const limit = parseInt($("limit1").value||"50",10) || 50;

    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶", true);
    google.script.run
      .withSuccessHandler(function(res){
        showRaw("rawP", res);

        if(!res){
          showMsg("msgP", "LIST: res = undefined/null (‡∏ù‡∏±‡πà‡∏á server ‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤)", "err");
          setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
          return;
        }
        if(!res.ok){
          showMsg("msgP", res.msg ? res.msg : ("LIST_FAIL\n"+JSON.stringify(res,null,2)), "err");
          setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
          return;
        }

        const rows = res.rows || [];
        $("cP").textContent = String(rows.length);

        const box = $("listP");
        if(!rows.length){
          box.innerHTML = card("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "EMPTY", "‚Äî");
          setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
          return;
        }

        let html = "";
        for(const r of rows){
          const lines =
            "created_at : "+(r.created_at||"-")+"\n"+
            "phone      : "+(r.phone||"-")+"\n"+
            "ua_key     : "+(r.ua_key||"-")+"\n"+
            "device_id  : "+(r.device_id||"-")+"\n"+
            "fingerprint: "+(r.fingerprint||"-")+"\n"+
            "note       : "+(r.note||"-");
          html += card("‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", r.phone||"-", lines);
        }
        box.innerHTML = html;
        setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
      })
      .withFailureHandler(function(err){
        showMsg("msgP", "LIST CALL FAIL: " + (err && err.message ? err.message : err), "err");
        setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
      })
      .rr365Admin_list("participants", limit, key, q);
  }

  function testListRaw(){
    hideMsg("msgP"); hideRaw("rawP");
    const key = keyAll();
    setStatus("‡∏ó‡∏î‡∏™‡∏≠‡∏ö LIST‚Ä¶", true);
    google.script.run
      .withSuccessHandler(function(res){
        showRaw("rawP", res);
        showMsg("msgP", "‡∏î‡∏π RAW RESPONSE ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", (res && res.ok) ? "ok" : "err");
        setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
      })
      .withFailureHandler(function(err){
        showMsg("msgP", "TEST CALL FAIL: " + (err && err.message ? err.message : err), "err");
        setStatus("‡∏û‡∏£‡πâ‡∏≠‡∏°", true);
      })
      .rr365Admin_list("participants", 5, key, "");
  }

  $("btnP").addEventListener("click", loadParticipants);
  $("btnPing").addEventListener("click", ping);
  $("btnTest").addEventListener("click", testListRaw);
  $("btnPClear").addEventListener("click", function(){
    $("q1").value=""; hideMsg("msgP"); hideRaw("rawP"); $("listP").innerHTML="";
  });

  ping();
</script>
</body>
</html>
