<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RR365 Admin Panel</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg0:#070102;
      --bg1:#0f0204;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --line:rgba(255,80,80,.20);
      --line2:rgba(255,80,80,.35);
      --txt:#ffecec;
      --muted:#ffb6b6;
      --accent:#ff2b2b;
      --accent2:#b80000;
      --ok:#36d399;
      --warn:#fbbf24;
      --bad:#ff5a5f;
      --shadow:0 22px 60px rgba(0,0,0,.65);
      --radius:20px;
      --radius2:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(255,60,60,.20), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(255,120,120,.10), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,40,40,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:26px 14px 60px;
    }

    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:18px 18px;
      border:1px solid var(--line);
      border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky;
      top:10px;
      z-index:10;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      min-width:240px;
    }
    .logo{
      width:46px; height:46px; border-radius:16px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 52%),
        linear-gradient(135deg, var(--accent), var(--accent2));
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 12px 30px rgba(255,0,0,.25);
    }
    .brand h1{
      font-size:16px; margin:0;
      letter-spacing:.4px;
      line-height:1.2;
    }
    .brand .sub{
      font-size:12px; color:var(--muted); margin-top:2px;
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.4fr .9fr;
      gap:14px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
      .topbar{flex-wrap:wrap}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 18px 46px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:linear-gradient(90deg, rgba(255,40,40,.12), transparent);
    }
    .card .hd .ttl{
      font-weight:700;
      font-size:14px;
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      color:var(--muted);
    }
    .card .bd{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{
      font-size:12px; color:var(--muted);
      display:block; margin-bottom:6px;
    }
    .field{flex:1; min-width:220px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      color:var(--txt);
      outline:none;
      transition:.15s;
    }
    input:focus, select:focus{
      border-color: rgba(255,80,80,.55);
      box-shadow:0 0 0 4px rgba(255,40,40,.15);
    }

    .btns{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:11px 14px;
      border-radius:14px;
      color:#fff;
      font-weight:700;
      letter-spacing:.2px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 14px 30px rgba(255,0,0,.25);
      transition:.15s;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0px); opacity:.92}
    .btn.secondary{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      color:var(--txt);
    }
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      color:var(--txt);
    }
    .btn.danger{
      background:linear-gradient(135deg, #ff3b3b, #a80000);
    }

    .status{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
      min-height:42px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.25);
      box-shadow:0 0 0 4px rgba(255,255,255,.06);
    }
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(54,211,153,.15)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,90,95,.15)}
    .dot.warn{background:var(--warn); box-shadow:0 0 0 4px rgba(251,191,36,.12)}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-weight:700;
      font-size:12px;
      transition:.15s;
    }
    .tab.active{
      color:#fff;
      border-color: rgba(255,80,80,.55);
      background:rgba(255,40,40,.12);
      box-shadow:0 0 0 4px rgba(255,40,40,.12);
    }

    .tableWrap{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:rgba(0,0,0,.22);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead th{
      text-align:left;
      padding:12px 10px;
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(90deg, rgba(255,40,40,.16), rgba(0,0,0,.05));
      position:sticky;
      top:0;
      z-index:2;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:var(--txt);
      vertical-align:top;
      word-break:break-word;
    }
    tbody tr:hover{
      background:rgba(255,255,255,.04);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      font-weight:800;
      font-size:11px;
      white-space:nowrap;
    }
    .badge.ok{border-color:rgba(54,211,153,.35); background:rgba(54,211,153,.10)}
    .badge.deny{border-color:rgba(255,90,95,.35); background:rgba(255,90,95,.10)}
    .badge.info{border-color:rgba(255,80,80,.28); background:rgba(255,40,40,.10)}

    .small{
      font-size:11px;
      color:var(--muted);
      line-height:1.45;
    }

    .split{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .split{grid-template-columns:1fr}
    }

    .footerNote{
      margin-top:14px;
      padding:12px 14px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.16);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12px;
    }

    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>RR365 Admin Panel</h1>
          <div class="sub">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° / Logs ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (ADMIN_KEY)</div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" id="tabParticipants">üë• Participants</div>
        <div class="tab" id="tabLogs">üßæ Logs</div>
      </div>

      <div class="status" style="min-width:280px;">
        <div class="dot" id="dot"></div>
        <div>
          <div id="statusText" style="color:#fff;font-weight:800;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
          <div class="small" id="statusSub">‡πÉ‡∏™‡πà Web App URL + Admin Key ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Äù</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div class="ttl">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
          <span class="pill">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡πÉ‡∏ä‡πâ ADMIN_KEY</span>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field" style="min-width:340px;">
              <label>Web App URL (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)</label>
              <input id="apiUrl" class="mono" placeholder="https://script.google.com/macros/s/AKfycbxEUgC2DJfJrzfB1eseO5p37NKyEO5lVMFYu-CzGscDq3gYaESzEjcu_NK7Z9wDmOHc/exec">
            </div>
            <div class="field">
              <label>ADMIN_KEY</label>
              <input id="adminKey" class="mono" placeholder="RR365_ADMIN_2026_CHANGE_ME">
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="split">
            <div class="field">
              <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (type)</label>
              <select id="typeSelect">
                <option value="participants">participants</option>
                <option value="logs">logs</option>
              </select>
            </div>
            <div class="field">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á (limit) 1-200</label>
              <input id="limit" type="number" min="1" max="200" value="50">
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="field">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏Å‡∏£‡∏≠‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)</label>
              <input id="search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 063 / fp / DENY / HARD_BLOCK / ua_key ...">
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row" style="align-items:center;">
            <div class="btns">
              <button class="btn" id="btnConnect">üîå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
              <button class="btn secondary" id="btnReload">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
              <button class="btn ghost" id="btnClear">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</button>
            </div>

            <div class="right" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <div style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="autoRefresh" />
                <label for="autoRefresh" style="margin:0;cursor:pointer;">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
              </div>
              <select id="autoEvery" style="width:auto; min-width:170px;">
                <option value="15">‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
                <option value="30" selected>‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
                <option value="60">‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
                <option value="120">‡∏ó‡∏∏‡∏Å 2 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
              </select>
            </div>
          </div>

          <div class="footerNote">
            <b>‡∏ó‡∏¥‡∏õ:</b> ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô ‚Äú‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô <span class="mono">ADMIN_KEY</span> ‡πÉ‡∏ô Apps Script ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß Deploy ‡πÉ‡∏´‡∏°‡πà
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div class="ttl">üß† ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ & ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
          <span class="pill">UI ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
        </div>
        <div class="bd">
          <div class="small">
            <div><b>Participants</b> = ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà ‚Äú‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‚Äù ‡∏≠‡∏¢‡∏π‡πà</div>
            <div><b>Logs</b> = ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î (OK/DENY + reason)</div>
            <div style="height:10px"></div>
            <div class="small">
              <b>‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:</b> ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó <span class="mono">participants</span> (‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏£‡πà‡∏ß‡∏°)
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:40%;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                  <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                </tr>
              </thead>
              <tbody id="lastResult">
                <tr>
                  <td><span class="badge info">INFO</span> ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</td>
                  <td class="small">‡πÉ‡∏™‡πà Web App URL + Admin Key ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Äù</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="height:14px"></div>

          <div class="small">
            <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ CORS:</b> ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ <span class="mono">fetch(POST)</span> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Web App ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á JSONP)
          </div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- TABLE -->
    <div class="card">
      <div class="hd">
        <div class="ttl">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        <div class="pill" id="countPill">0 ‡πÅ‡∏ñ‡∏ß</div>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <table id="dataTable">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div style="height:10px"></div>
        <div class="small" id="hint"></div>
      </div>
    </div>

  </div>

<script>
/* =========================
   Admin UI (RR365)
========================= */

const $ = (id)=>document.getElementById(id);

let connected = false;
let currentType = "participants";
let allRows = [];
let timer = null;

function setStatus(state, title, sub){
  const dot = $("dot");
  dot.className = "dot";
  if(state==="ok") dot.classList.add("ok");
  else if(state==="bad") dot.classList.add("bad");
  else if(state==="warn") dot.classList.add("warn");

  $("statusText").textContent = title || "";
  $("statusSub").textContent = sub || "";
}

function setLastResult(kind, left, right){
  const badgeClass = kind==="OK" ? "ok" : (kind==="DENY" ? "deny" : "info");
  $("lastResult").innerHTML = `
    <tr>
      <td><span class="badge ${badgeClass}">${kind}</span> ${escapeHtml(left||"")}</td>
      <td class="small">${escapeHtml(right||"")}</td>
    </tr>
  `;
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function getCfg(){
  const url = $("apiUrl").value.trim();
  const key = $("adminKey").value.trim();
  const limit = Math.max(1, Math.min(200, parseInt($("limit").value||"50",10) || 50));
  const type = $("typeSelect").value;
  return { url, key, limit, type };
}

async function postJSON(url, data){
  const res = await fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(data)
  });
  return await res.json();
}

async function connectAndLoad(){
  const { url, key } = getCfg();
  if(!url || !url.includes("/exec")){
    setStatus("bad","URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec");
    setLastResult("DENY","URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏à‡∏≤‡∏Å Deploy");
    connected=false;
    return;
  }
  if(!key){
    setStatus("bad","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà ADMIN_KEY","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ADMIN_KEY ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Apps Script");
    setLastResult("DENY","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà ADMIN_KEY","‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    connected=false;
    return;
  }

  setStatus("warn","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö");
  setLastResult("INFO","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î","‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");

  try{
    // ‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    await loadData(true);
    connected=true;
    setStatus("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß");
  }catch(err){
    connected=false;
    setStatus("bad","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", String(err));
    setLastResult("DENY","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", String(err));
  }
}

async function loadData(isFirst=false){
  const { url, key, limit, type } = getCfg();
  currentType = type;

  const payload = {
    action:"admin_list",
    admin_key:key,
    type:type,
    limit:limit
  };

  const data = await postJSON(url, payload);

  if(!data || data.ok !== true){
    const msg = (data && (data.msg || data.code)) ? (data.msg || data.code) : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏";
    setStatus("bad","‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", msg);
    setLastResult("DENY","‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", msg);
    throw new Error(msg);
  }

  allRows = Array.isArray(data.rows) ? data.rows : [];
  renderTable();
  setLastResult("OK", `‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${type})`, `‡πÑ‡∏î‡πâ ${allRows.length} ‡πÅ‡∏ñ‡∏ß | limit=${limit}`);
  if(isFirst){
    $("hint").textContent = "üí° ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó ‡∏´‡∏£‡∏∑‡∏≠ limit ‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ";
  }
}

function renderTable(){
  const q = $("search").value.trim().toLowerCase();
  let rows = allRows;

  if(q){
    rows = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
  }

  $("countPill").textContent = `${rows.length} ‡πÅ‡∏ñ‡∏ß`;

  if(currentType === "participants"){
    $("thead").innerHTML = `
      <tr>
        <th style="width:18%;">created_at</th>
        <th style="width:14%;">phone</th>
        <th style="width:18%;">ua_key</th>
        <th style="width:16%;">device_id</th>
        <th style="width:18%;">fingerprint</th>
        <th>note</th>
      </tr>`;
    $("tbody").innerHTML = rows.map(r => `
      <tr>
        <td class="small">${escapeHtml(formatDateMaybe(r.created_at))}</td>
        <td class="mono">${escapeHtml(r.phone)}</td>
        <td class="mono small">${escapeHtml(r.ua_key)}</td>
        <td class="mono small">${escapeHtml(r.device_id)}</td>
        <td class="mono small">${escapeHtml(r.fingerprint)}</td>
        <td class="small">${escapeHtml(r.note||"")}</td>
      </tr>
    `).join("") || emptyRow("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• participants");
    return;
  }

  // logs
  $("thead").innerHTML = `
    <tr>
      <th style="width:16%;">ts</th>
      <th style="width:10%;">action</th>
      <th style="width:12%;">phone_raw</th>
      <th style="width:12%;">phone_normalized</th>
      <th style="width:12%;">device_id</th>
      <th style="width:14%;">fingerprint</th>
      <th style="width:10%;">ua_key</th>
      <th style="width:10%;">result</th>
      <th>message</th>
    </tr>`;

  $("tbody").innerHTML = rows.map(r => {
    const isOk = String(r.result||"").toUpperCase()==="OK";
    const badge = isOk ? `<span class="badge ok">OK</span>` : `<span class="badge deny">${escapeHtml(r.result||"DENY")}</span>`;
    return `
      <tr>
        <td class="small">${escapeHtml(formatDateMaybe(r.ts))}</td>
        <td class="mono small">${escapeHtml(r.action)}</td>
        <td class="mono small">${escapeHtml(r.phone_raw)}</td>
        <td class="mono small">${escapeHtml(r.phone_normalized)}</td>
        <td class="mono small">${escapeHtml(r.device_id)}</td>
        <td class="mono small">${escapeHtml(r.fingerprint)}</td>
        <td class="mono small">${escapeHtml(r.ua_key)}</td>
        <td>${badge}</td>
        <td class="small">${escapeHtml(r.message||"")}</td>
      </tr>
    `;
  }).join("") || emptyRow("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• logs");
}

function emptyRow(msg){
  return `<tr><td colspan="9" class="small" style="padding:16px;color:var(--muted);">${escapeHtml(msg)}</td></tr>`;
}

function formatDateMaybe(v){
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Date string / ISO / ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ
  if(!v) return "";
  const s = String(v);
  // ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ Apps Script ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô "Tue Dec 26 2025 ..." ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ISO ‡∏•‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    return d.toLocaleString("th-TH", { hour12:false });
  }
  return s;
}

function setType(type){
  $("typeSelect").value = type;
  currentType = type;
  renderTable(); // ‡∏à‡∏∞‡πÉ‡∏ä‡πâ allRows ‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÇ‡∏´‡∏•‡∏î)
}

function syncTabs(){
  const t = $("typeSelect").value;
  $("tabParticipants").classList.toggle("active", t==="participants");
  $("tabLogs").classList.toggle("active", t==="logs");
}

function startAuto(){
  stopAuto();
  if(!$("autoRefresh").checked) return;
  const sec = parseInt($("autoEvery").value,10) || 30;
  timer = setInterval(async ()=>{
    if(!connected) return;
    try{ await loadData(false); }
    catch(_){}
  }, sec*1000);
}
function stopAuto(){
  if(timer){ clearInterval(timer); timer=null; }
}

function clearUI(){
  allRows = [];
  $("thead").innerHTML = "";
  $("tbody").innerHTML = "";
  $("countPill").textContent = "0 ‡πÅ‡∏ñ‡∏ß";
  $("search").value = "";
  setStatus("warn","‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß","‡∏Å‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà");
  setLastResult("INFO","‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß","‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó");
}

function bindEvents(){
  $("btnConnect").addEventListener("click", async ()=>{ await connectAndLoad(); startAuto(); });
  $("btnReload").addEventListener("click", async ()=>{
    if(!connected){
      await connectAndLoad();
    }else{
      await loadData(false);
    }
  });
  $("btnClear").addEventListener("click", clearUI);

  $("search").addEventListener("input", renderTable);

  $("typeSelect").addEventListener("change", async ()=>{
    syncTabs();
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô type ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
    if(connected){
      await loadData(false);
    }
  });

  $("tabParticipants").addEventListener("click", async ()=>{
    setType("participants");
    syncTabs();
    if(connected) await loadData(false);
  });
  $("tabLogs").addEventListener("click", async ()=>{
    setType("logs");
    syncTabs();
    if(connected) await loadData(false);
  });

  $("autoRefresh").addEventListener("change", startAuto);
  $("autoEvery").addEventListener("change", startAuto);
}

(function init(){
  bindEvents();
  syncTabs();
  setStatus("warn","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠","‡πÉ‡∏™‡πà Web App URL + Admin Key ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Äù");
})();
</script>
</body>
</html>
