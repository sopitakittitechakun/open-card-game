<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RR365 Admin</title>
<style>
  :root{
    --bg:#0b0b0b;--line:rgba(255,255,255,.12);--txt:#fff;--muted:#cfcfcf;
    --card:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
  }
  *{box-sizing:border-box}
  body{margin:0;padding:18px;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:980px;margin:0 auto}
  .card{border:1px solid var(--line);background:var(--card);border-radius:18px;padding:14px}
  h1{margin:0 0 10px;font-size:18px}
  .grid{display:grid;grid-template-columns:1.1fr 1fr 1fr 1fr;gap:10px}
  label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
  input,select{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
    background:#0f0f0f;color:#fff;font-size:14px
  }
  .row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  button{
    border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;color:#fff;
    background:#2a2a2a
  }
  .ok{background:linear-gradient(135deg,#22c55e,#16a34a)}
  .bad{background:linear-gradient(135deg,#ff2b2b,#b80000)}
  .alt{background:#2a2a2a}
  .msg{margin-top:10px;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);white-space:pre-line;display:none}
  .tbl{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
  .tbl th{color:#cfcfcf;text-align:left;font-size:12px;font-weight:800;padding:0 10px}
  .tbl td{background:rgba(0,0,0,.25);border:1px solid var(--line);padding:10px;border-left:0;border-right:0}
  .tbl tr td:first-child{border-left:1px solid var(--line);border-radius:12px 0 0 12px}
  .tbl tr td:last-child{border-right:1px solid var(--line);border-radius:0 12px 12px 0}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .PENDING{border-color:rgba(255,255,255,.25)}
  .APPROVED{border-color:rgba(34,197,94,.5)}
  .REJECTED{border-color:rgba(255,43,43,.5)}
  .USED{border-color:rgba(59,130,246,.5)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üõ°Ô∏è RR365 Admin (‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</h1>

    <div class="grid">
      <div>
        <label>‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
        <input id="token" value="RR365-ADMIN-2026" />
      </div>
      <div>
        <label>‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
        <select id="status">
          <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="PENDING">PENDING (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
          <option value="APPROVED">APPROVED</option>
          <option value="REJECTED">REJECTED</option>
          <option value="USED">USED</option>
        </select>
      </div>
      <div>
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</label>
        <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô 063 ‡∏´‡∏£‡∏∑‡∏≠ 87044"/>
      </div>
      <div>
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î (1-500)</label>
        <input id="limit" inputmode="numeric" value="200"/>
      </div>
    </div>

    <div class="row">
      <button id="btnLoad" class="alt" type="button">üì• ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
      <button id="btnLoadToday" class="alt" type="button">üìÖ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button id="btnRefresh" class="alt" type="button">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>

    <div class="msg" id="msg"></div>

    <table class="tbl" id="tbl">
      <thead>
        <tr>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡πÇ‡∏Ñ‡πâ‡∏î</th>
          <th>Device</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const SCRIPT_URL = "<?= ScriptApp.getService().getUrl() ?>";

const $msg=document.getElementById("msg");
const $tbody=document.getElementById("tbody");

function show(t){
  $msg.style.display="block";
  $msg.textContent=t;
}
function hideMsg(){ $msg.style.display="none"; $msg.textContent=""; }

function jsonp(params){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    params.callback=cb; params._ts=Date.now();
    const s=document.createElement("script");
    s.src = SCRIPT_URL + "?" + new URLSearchParams(params).toString();
    window[cb]=(d)=>{ try{delete window[cb];}catch(_){window[cb]=undefined;} s.remove(); res(d); };
    s.onerror=()=>{ try{delete window[cb];}catch(_){window[cb]=undefined;} s.remove(); rej(new Error("JSONP_ERROR")); };
    document.body.appendChild(s);
  });
}

function fmt(iso){
  if(!iso) return "-";
  try{
    const d=new Date(iso);
    return d.toLocaleString("th-TH",{hour12:false});
  }catch(_){ return "-"; }
}

async function loadList(today=false){
  hideMsg();
  $tbody.innerHTML = "";
  const token=document.getElementById("token").value.trim();
  const status=document.getElementById("status").value;
  const q=document.getElementById("q").value.trim();
  const limit=document.getElementById("limit").value.trim() || "200";

  if(!token) return show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");

  show("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
  const d = await jsonp({action:"admin_list", token, status, q, limit, today: today?1:0}).catch(()=>null);
  if(!d) return show("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  if(!d.ok) return show("‚ùå "+(d.msg||"‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));

  const rows = d.rows || [];
  if(!rows.length){
    show("‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç");
    return;
  }
  show(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

  for(const r of rows){
    const tr=document.createElement("tr");

    const tdTime=document.createElement("td");
    tdTime.textContent = fmt(r.created_at);
    tr.appendChild(tdTime);

    const tdPhone=document.createElement("td");
    tdPhone.textContent = r.phone || "-";
    tr.appendChild(tdPhone);

    const tdStatus=document.createElement("td");
    const st = (r.status||"UNKNOWN").toUpperCase();
    tdStatus.innerHTML = `<span class="pill ${st}">${st}</span>`;
    tr.appendChild(tdStatus);

    const tdCode=document.createElement("td");
    tdCode.textContent = r.promo_code || "-";
    tr.appendChild(tdCode);

    const tdDev=document.createElement("td");
    tdDev.className="mono";
    tdDev.textContent = (r.device_key||"").slice(0,16) + (r.device_key && r.device_key.length>16 ? "‚Ä¶" : "");
    tr.appendChild(tdDev);

    const tdAct=document.createElement("td");
    tdAct.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="ok"  data-op="APPROVE">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
        <button class="bad" data-op="REJECT">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        <button class="alt" data-op="USED">‡∏ï‡∏±‡πâ‡∏á USED</button>
      </div>
    `;
    tdAct.querySelectorAll("button").forEach(btn=>{
      btn.onclick = ()=> adminOp(btn.dataset.op, r.row_index, r.phone);
    });
    tr.appendChild(tdAct);

    $tbody.appendChild(tr);
  }
}

async function adminOp(op, row_index, phone){
  const token=document.getElementById("token").value.trim();
  if(!token) return show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");

  show(`‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${op} ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ...`);
  const d = await jsonp({action:"admin_action", token, op, row_index, phone}).catch(()=>null);
  if(!d) return show("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  if(!d.ok) return show("‚ùå "+(d.msg||"‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));

  if(d.promo_code){
    show(`‚úÖ ${d.msg}\n‡πÇ‡∏Ñ‡πâ‡∏î: ${d.promo_code}`);
  }else{
    show(`‚úÖ ${d.msg}`);
  }
  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  await loadList(false);
}

document.getElementById("btnLoad").onclick=()=>loadList(false);
document.getElementById("btnLoadToday").onclick=()=>loadList(true);
document.getElementById("btnRefresh").onclick=()=>loadList(false);

// ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
loadList(false);
</script>
</body>
</html>
