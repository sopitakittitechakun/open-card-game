<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ | ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:'Sarabun',sans-serif; overflow-x:hidden; }
    body { background: linear-gradient(-45deg, #ffcc00, #ff9900, #ffd700, #fff4c2);
           background-size: 400% 400%; animation: gradientMove 15s ease infinite; }
    @keyframes gradientMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    #particles-js { position:fixed; width:100%; height:100%; z-index:0; }

    .promo-banner { text-align:center; margin:20px auto 10px; z-index:2; position:relative; }
    .promo-banner img { max-width:90%; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,0.4); }

    .container { position:relative; z-index:1; text-align:center; color:#fff8dc;
      background:rgba(0,0,0,0.4); padding:20px; border-radius:18px;
      box-shadow:0 0 15px rgba(255,215,0,0.5); max-width:520px; margin:0 auto 16px; }
    .logo { width:150px; margin-bottom:16px; filter:drop-shadow(2px 2px 4px #000); }
    h2 { font-size:26px; color:#ffd700; text-shadow:0 0 5px #fff, 0 0 12px #ff9900; }

    input, button { padding:12px; font-size:16px; border-radius:10px; margin-bottom:8px;
      width:90%; max-width:340px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    input { border:2px solid #ffcc00; color:#5a2e00; font-weight:bold; text-align:center; }
    button { background:linear-gradient(to right,#ffd700,#ff9900); color:#3b1c00; font-weight:bold; border:none; cursor:pointer; }

    #cards { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:20px; }
    .card { width:90px; height:130px; perspective:1000px; position:relative; }
    .inner-card { width:100%; height:100%; transition:transform 0.8s; transform-style:preserve-3d; position:relative; }
    .card.opened .inner-card { transform: rotateY(180deg); }
    .front, .back { position:absolute; width:100%; height:100%; border-radius:12px; backface-visibility:hidden;
      display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:bold;
      border:3px solid gold; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    .front { background:#fff8dc; color:#b71c1c; }
    .back  { background:#ffd700; transform:rotateY(180deg); }
    .back span { font-size:42px; font-weight:bold; color:#b71c1c; }

    .winners{ margin:16px auto 32px; max-width:520px; background:rgba(255, 215, 0, 0.08);
      border:1px solid rgba(255, 215, 0, 0.35); border-radius:14px; box-shadow:0 0 12px rgba(255,215,0,0.2) inset; overflow:hidden; }
    .winners-head{ padding:10px 14px; background:linear-gradient(90deg, rgba(255,215,0,0.25), rgba(255,153,0,0.25));
      color:#ffd700; font-weight:bold; letter-spacing:0.3px; display:flex; align-items:center; gap:8px; }
    .winner-list{ list-style:none; margin:0; padding:8px 12px; max-height:180px; overflow:auto; }
    .winner-list li{ display:flex; justify-content:space-between; align-items:center;
      color:#fff8dc; padding:8px 6px; border-bottom:1px dashed rgba(255,215,0,0.15); font-size:15px; }
    .winner-list li .badge{ background:#22c55e; color:#0b2a0f; font-weight:bold; font-size:12px;
      padding:4px 8px; border-radius:999px; box-shadow:0 0 8px rgba(34,197,94,0.4); }
    .winner-list li .time{ opacity:0.85; font-size:12px; margin-left:10px; }
    .empty{ padding:10px 14px; color:#fff; opacity:.85; }

    .error { max-width:520px; margin:0 auto 12px; background:rgba(190,0,0,.15); border:1px solid rgba(190,0,0,.35);
      color:#fff; padding:10px 14px; border-radius:12px; display:none; }
    .error b{ color:#fff }
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <div class="promo-banner">
    <img src="https://img5.pic.in.th/file/secure-sv1/photo_--_--72c7c95c2df97877.jpg" alt="‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ">
  </div>

  <div id="errBox" class="error"></div>

  <div class="container">
    <img class="logo" src="https://img2.pic.in.th/pic/1735020594-1.png" alt="‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365">
    <h2>üÇ™ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ | ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365</h2>

    <input type="text" id="adminCode" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ä‡πà‡∏ô ABCD-1234" maxlength="16"><br>
    <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    <div id="quotaInfo"></div>

    <div id="captureZone">
      <div id="cards"></div>
      <div id="rewardDisplay"></div>
    </div>

    <button id="captureBtn" style="display:none;">üì∏ ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</button>
  </div>

  <div class="winners">
    <div class="winners-head">üéâ ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
    <ul id="winnerList" class="winner-list"></ul>
    <div id="winnerEmpty" class="empty" style="display:none;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
  </div>

  <audio id="flipSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_72b2a6d7f8.mp3" preload="auto"></audio>
  <audio id="jackpotSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b9b19751f3.mp3" preload="auto"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    /* ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ===== */
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzpofdRjZiZ56BhaixItPMfL4gydPrl19QOewbFKxxxmHIiz6KnbfVdeBC-BmErUAMK/exec';
    const WIN_NUMBER = 6;
    const JACKPOT_INCLUDE_RATE = 0.30;
    const WINNER_REFRESH_MS = 30000;

    /* ===== Error helper ===== */
    function showErr(msg){ const box=document.getElementById('errBox'); if(!box) return alert(msg); box.innerHTML = '<b>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b> '+(msg||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'); box.style.display='block'; setTimeout(()=>{box.style.display='none';}, 8000); }

    /* ===== GET + JSONP fallback ===== */
    async function callAPI(params){
      const url = scriptURL + '?' + new URLSearchParams(params).toString();
      try {
        const res = await fetch(url, { method:'GET', cache:'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
        const ct = (res.headers.get('content-type')||'').toLowerCase();
        if (!ct.includes('application/json')) { const txt = await res.text(); throw new Error('‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: '+txt.slice(0,140)); }
        return await res.json();
      } catch(e){
        return await jsonp(url);
      }
    }
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = 'cb'+Date.now()+Math.floor(Math.random()*1000);
        const s = document.createElement('script');
        const timer = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, 10000);
        function cleanup(){ clearTimeout(timer); delete window[cb]; s.remove(); }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP failed')); };
        document.body.appendChild(s);
      });
    }

    /* ===== Session/Device ===== */
    function getDeviceId(){ let id = localStorage.getItem('rr365_device'); if (!id) { id = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)); localStorage.setItem('rr365_device', id); } return id; }
    function getSession(){ return localStorage.getItem('rr365_session') || ''; }
    function setSession(tok){ localStorage.setItem('rr365_session', tok); }

    /* ===== Verify code-only ===== */
    async function verifyCode(code){
      const data = await callAPI({ mode:'verify_code', code, deviceId:getDeviceId() });
      if (!data.ok || !data.session) throw new Error(data.error || '‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      setSession(data.session);
      return true;
    }

    async function loadQuotaThenShow(){
      const data = await callAPI({ mode:'quota', deviceId:getDeviceId(), session:getSession() });
      if (data.error) throw new Error(data.error);
      if (typeof data.limit !== 'undefined'){
        const left = Math.max(0, (data.limit||1) - (data.playedToday||0));
        document.getElementById('quotaInfo').textContent = `‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${left}/${data.limit || 1}`;
      }
      if (data.alreadyPlayed) throw new Error(`‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÅ‡∏•‡πâ‡∏ß (${data.playedToday}/${data.limit})`);
      showCards();
    }

    document.getElementById('startBtn').addEventListener('click', async ()=>{
      const btn = document.getElementById('startBtn');
      const code = document.getElementById('adminCode').value.trim();
      if (!/^[A-Za-z0-9-]{4,16}$/.test(code)) { showErr('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô ABCD-1234'); return; }
      btn.disabled = true; const old = btn.textContent; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î...';
      try { await verifyCode(code); await loadQuotaThenShow(); }
      catch(e){ console.error(e); showErr(e.message || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
      finally{ btn.disabled = false; btn.textContent = old; }
    });

    /* ===== ‡πÄ‡∏Å‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà ===== */
    let hasFlipped = false;
    function showCards(){
      hasFlipped = false;
      document.getElementById('cards').innerHTML = '';
      document.getElementById('rewardDisplay').innerHTML = '';
      document.getElementById('captureBtn').style.display = 'none';
      let numbers = [1,2,3,4,5,5];
      if (Math.random() < JACKPOT_INCLUDE_RATE) numbers[Math.floor(Math.random()*numbers.length)] = WIN_NUMBER;
      numbers = shuffleArray(numbers);
      numbers.forEach(num => {
        const wrapper = document.createElement('div'); wrapper.className = 'card';
        const inner = document.createElement('div'); inner.className = 'inner-card';
        const front = document.createElement('div'); front.className = 'front'; front.textContent = '?';
        const back  = document.createElement('div'); back.className  = 'back';
        const label = document.createElement('span'); label.textContent = num; back.appendChild(label);
        inner.appendChild(front); inner.appendChild(back); wrapper.appendChild(inner);
        wrapper.onclick = () => flipCard(wrapper, num);
        document.getElementById('cards').appendChild(wrapper);
      });
    }

    function flipCard(card, number){
      if (hasFlipped) return; hasFlipped = true;
      document.getElementById('flipSound').play();
      card.classList.add('opened');
      document.querySelectorAll('.card').forEach(c => c.onclick = null);

      let message = '';
      if (number === WIN_NUMBER){
        document.getElementById('jackpotSound').play();
        celebrateConfetti();
        message = `üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç <b>${number}</b><br>üì∏ ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•`;
        pushWinnerImmediate({code:'(this-session)', reward: WIN_NUMBER, ts: Date.now()});
      } else {
        message = `üò¢ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç <b>${number}</b> ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏¢‡∏±‡∏á‡∏°‡∏µ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`;
      }
      document.getElementById('rewardDisplay').innerHTML = `<div class='reward-text'>${message}</div>`;
      document.getElementById('captureBtn').style.display = 'inline-block';

      callAPI({ mode:'play', reward:number, deviceId:getDeviceId(), session:getSession() })
        .catch(err=>console.warn('log play failed:', err.message));
    }

    document.getElementById('captureBtn').addEventListener('click', () => {
      html2canvas(document.getElementById('captureZone')).then(canvas => {
        const link = document.createElement('a');
        link.download = '‡∏ú‡∏•‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    function celebrateConfetti(){
      const duration = 2000, end = Date.now() + duration;
      const defaults = { startVelocity:35, spread:360, ticks:60, zIndex:9999 };
      const iv = setInterval(()=>{
        const timeLeft = end - Date.now(); if (timeLeft<=0) return clearInterval(iv);
        if (window.confetti) window.confetti(Object.assign({}, defaults, {
          particleCount: 80*(timeLeft/duration), origin: {x:Math.random(), y:Math.random()-0.2}
        }));
      },200);
    }
    function shuffleArray(arr){ for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j]]; } return arr; }

    /* ===== Winners ===== */
    function renderWinners(list){
      const ul = document.getElementById('winnerList');
      const empty = document.getElementById('winnerEmpty');
      ul.innerHTML = '';
      if (!list || list.length === 0) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      list.forEach(w=>{
        const li = document.createElement('li');
        const left = document.createElement('div');
        left.textContent = `‡πÇ‡∏Ñ‡πâ‡∏î ${w.code || '‚Äî'} ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç ${w.reward}`;
        const right = document.createElement('div');
        const badge = document.createElement('span'); badge.className = 'badge';
        badge.textContent = (String(w.reward) === String(WIN_NUMBER) ? 'JACKPOT' : '‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ');
        const tm = document.createElement('span'); tm.className = 'time';
        tm.textContent = `‚Ä¢ ${timeAgo(w.ts || Date.now())} ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        right.appendChild(badge); right.appendChild(tm);
        li.appendChild(left); li.appendChild(right);
        ul.appendChild(li);
      });
    }
    function timeAgo(ts){
      try{ const t = typeof ts==='number'?ts:new Date(ts).getTime();
        let d = Math.max(0, Math.floor((Date.now()-t)/1000));
        if(d<60) return `${d} ‡∏ß‡∏¥`; if(d<3600) return `${Math.floor(d/60)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        if(d<86400) return `${Math.floor(d/3600)} ‡∏ä‡∏°.`; return `${Math.floor(d/86400)} ‡∏ß‡∏±‡∏ô`;
      }catch{return ''}
    }
    function saveWinnerCache(list){ try{ localStorage.setItem('rr365_winners_codeonly', JSON.stringify({ts:Date.now(), list})); }catch{} }
    function loadWinnerCache(){ try{ const raw=localStorage.getItem('rr365_winners_codeonly'); return raw?JSON.parse(raw).list:null; }catch{ return null; } }
    function WINNER_FETCH_URL(){ return scriptURL + '?mode=winners&jackpot=' + WIN_NUMBER + '&t=' + Date.now(); }
    async function fetchWinners(){
      try{
        const res = await fetch(WINNER_FETCH_URL(), {cache:'no-store'});
        const ct = (res.headers.get('content-type')||'').toLowerCase();
        if (!res.ok || !ct.includes('application/json')) throw 0;
        const data = await res.json(); if (Array.isArray(data)) { saveWinnerCache(data); return data; }
        return [];
      }catch{ return loadWinnerCache() || []; }
    }
    async function loadWinners(){ renderWinners(await fetchWinners()); }
    function pushWinnerImmediate(entry){
      const cached = loadWinnerCache() || [];
      const newList = [entry, ...cached].slice(0, 50);
      saveWinnerCache(newList); renderWinners(newList);
    }

    document.addEventListener('DOMContentLoaded', ()=>{ loadWinners(); setInterval(loadWinners, WINNER_REFRESH_MS); });
    particlesJS('particles-js', { particles:{ number:{value:60}, size:{value:4}, color:{value:'#ffd700'}, opacity:{value:0.6}, move:{speed:1.5}, line_linked:{enable:false} },
      interactivity:{ events:{ onhover:{ enable:false } } } });
  </script>
</body>
</html>
