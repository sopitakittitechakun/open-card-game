<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
<style>
  body{font-family:system-ui;background:#0b0b0b;color:#fff;margin:0;padding:24px}
  .card{max-width:560px;margin:0 auto;background:#141414;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;position:relative}
  h1{font-size:20px;margin:0 0 8px}
  p{opacity:.85;margin:0 0 14px;line-height:1.55}
  label{display:block;margin:10px 0 6px;opacity:.9}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f0f0f;color:#fff;font-size:16px}

  button{
    width:100%;
    padding:12px 14px;
    border-radius:12px;
    border:0;
    background:#ff2b2b;
    color:#fff;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    margin-top:12px;
    position:relative;
    z-index:10;
    pointer-events:auto;
    touch-action:manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  button.secondary{background:#8d1a1a}
  button:disabled{opacity:.55;cursor:not-allowed}

  .msg{margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);white-space:pre-line;display:none}
  .ok{border-color:rgba(0,255,140,.25)} .err{border-color:rgba(255,60,60,.35)}
  .small{font-size:12px;opacity:.7;margin-top:10px}
</style>
</head>
<body>

<div class="card">
  <h1>üìå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
  <p>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå/1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ‡πÅ‡∏•‡∏∞ 1 ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>

  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
  <input id="phone" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0631087044"/>

  <button id="btnCheck" type="button" onclick="runCheck()">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
  <button id="btnJoin" type="button" onclick="runRegister()" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>

  <div id="msg" class="msg"></div>
  <div class="small">* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏°‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</div>
</div>

<script>
  // ‚úÖ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Web App /exec ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFDCqjkEpps69bguwp9fVZ8mn4v-4-rTVO1YQ0iy-3Cxoy1Z78yqnE5xWp4t2T4LXupA/exec";

  const DEVICE_JOIN_KEY = "rr365_joined_activity";
  const DEVICE_ID_KEY   = "rr365_device_id";

  const $phone = document.getElementById("phone");
  const $btnCheck = document.getElementById("btnCheck");
  const $btnJoin  = document.getElementById("btnJoin");
  const $msg = document.getElementById("msg");

  function show(text, type="ok"){
    $msg.style.display="block";
    $msg.className="msg "+(type==="err"?"err":"ok");
    $msg.textContent=text;
  }

  function normalizePhone(v){
    let p=(v||"").replace(/\D/g,"");
    if(!p) return "";
    if(p.startsWith("66")) p="0"+p.slice(2);
    if(p.length===9) p="0"+p;
    if(p.length===10 && p.startsWith("0")) return p;
    return "";
  }

  function getOrCreateDeviceId(){
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if(!id){
      id = "dev_"+Math.random().toString(36).slice(2)+Date.now().toString(36);
      localStorage.setItem(DEVICE_ID_KEY,id);
    }
    return id;
  }

  function alreadyJoined(){
    return localStorage.getItem(DEVICE_JOIN_KEY)==="1";
  }
  function markJoined(){
    localStorage.setItem(DEVICE_JOIN_KEY,"1");
  }

  // ---------- JSONP helper (‡∏Å‡∏±‡∏ô CORS 100%) ----------
  function jsonpRequest(params){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      params.jsonp = "1";
      params.callback = cbName;

      const qs = new URLSearchParams(params).toString();
      const url = SCRIPT_URL + "?" + qs;

      const script = document.createElement("script");
      script.src = url;
      script.async = true;

      window[cbName] = (data)=>{
        cleanup();
        resolve(data);
      };

      script.onerror = ()=>{
        cleanup();
        reject(new Error("JSONP error"));
      };

      function cleanup(){
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      document.body.appendChild(script);
      setTimeout(()=>{ try{ cleanup(); }catch(e){} reject(new Error("timeout")); }, 12000);
    });
  }

  async function request(action){
    const p = normalizePhone($phone.value);
    if(!p){ show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 0631087044)", "err"); return null; }

    const payload = {
      action,
      phone: p,
      deviceId: getOrCreateDeviceId(),
      userAgent: navigator.userAgent
    };

    try{
      return await jsonpRequest(payload); // ‚úÖ ‡∏•‡πá‡∏≠‡∏Å JSONP ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    }catch(e){
      return null;
    }
  }

  // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å onclick
  window.runCheck = async function(){
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥)
    if(alreadyJoined()){
      show("‚ö†Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ", "err");
      return;
    }

    $btnCheck.disabled=true;
    $btnJoin.disabled=true;

    const data = await request("check");
    $btnCheck.disabled=false;

    if(!data){
      show("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£ Deploy", "err");
      return;
    }

    if(!data.ok){
      show(data.msg || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "err");
      return;
    }

    if(data.device_used){
      show("‚ö†Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)", "err");
      return;
    }
    if(data.exists){
      show("‚ö†Ô∏è ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)", "err");
      return;
    }

    show("‚úÖ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢", "ok");
    $btnJoin.disabled=false;
  }

  window.runRegister = async function(){
    if(alreadyJoined()){
      show("‚ö†Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ", "err");
      return;
    }

    $btnCheck.disabled=true;
    $btnJoin.disabled=true;

    const data = await request("register");
    $btnCheck.disabled=false;

    if(!data){
      show("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£ Deploy", "err");
      return;
    }

    if(!data.ok){
      show(data.msg || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "err");
      return;
    }

    if(data.registered){
      markJoined();
      show("üéâ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß", "ok");
      return;
    }

    show(data.msg || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ", "err");
  }
</script>
</body>
</html>
