<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ | ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:'Sarabun',sans-serif; overflow-x:hidden; }
    body { background: linear-gradient(-45deg, #ffcc00, #ff9900, #ffd700, #fff4c2);
           background-size: 400% 400%; animation: gradientMove 15s ease infinite; }
    @keyframes gradientMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    #particles-js { position:fixed; width:100%; height:100%; z-index:0; }

    .promo-banner { text-align:center; margin:20px auto 10px; z-index:2; position:relative; }
    .promo-banner img { max-width:90%; border-radius:14px; box-shadow:0 6px 16px rgba(0,0,0,0.4); }

    .container { position:relative; z-index:1; text-align:center; color:#fff8dc;
      background:rgba(0,0,0,0.4); padding:20px; border-radius:18px;
      box-shadow:0 0 15px rgba(255,215,0,0.5); max-width:500px; margin:0 auto 16px; }
    .logo { width:150px; margin-bottom:16px; filter:drop-shadow(2px 2px 4px #000); }
    h2 { font-size:26px; color:#ffd700; text-shadow:0 0 5px #fff, 0 0 12px #ff9900; }

    input, button { padding:12px; font-size:16px; border-radius:10px; margin-bottom:8px;
      width:90%; max-width:300px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    input { border:2px solid #ffcc00; color:#5a2e00; font-weight:bold; text-align:center; }
    button { background:linear-gradient(to right,#ffd700,#ff9900); color:#3b1c00; font-weight:bold; border:none; cursor:pointer; }

    #cards { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:20px; }
    .card { width:90px; height:130px; perspective:1000px; position:relative; }
    .inner-card { width:100%; height:100%; transition:transform 0.8s; transform-style:preserve-3d; position:relative; }
    .card.opened .inner-card { transform: rotateY(180deg); }
    .front, .back { position:absolute; width:100%; height:100%; border-radius:12px; backface-visibility:hidden;
      display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:bold;
      border:3px solid gold; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    .front { background:#fff8dc; color:#b71c1c; }
    .back  { background:#ffd700; transform:rotateY(180deg); }
    .back span { font-size:42px; font-weight:bold; color:#b71c1c; }

    .winners{ margin:16px auto 32px; max-width:500px; background:rgba(255,215,0,0.08);
      border:1px solid rgba(255,215,0,0.35); border-radius:14px; box-shadow:0 0 12px rgba(255,215,0,0.2) inset; overflow:hidden; }
    .winners-head{ padding:10px 14px; background:linear-gradient(90deg, rgba(255,215,0,0.25), rgba(255,153,0,0.25));
      color:#ffd700; font-weight:bold; letter-spacing:0.3px; display:flex; align-items:center; gap:8px; }
    .winner-list{ list-style:none; margin:0; padding:8px 12px; max-height:180px; overflow:auto; }
    .winner-list li{ display:flex; justify-content:space-between; align-items:center;
      color:#fff8dc; padding:8px 6px; border-bottom:1px dashed rgba(255,215,0,0.15); font-size:15px; }
    .winner-list li .badge{ background:#22c55e; color:#0b2a0f; font-weight:bold; font-size:12px;
      padding:4px 8px; border-radius:999px; box-shadow:0 0 8px rgba(34,197,94,0.4); }
    .winner-list li .time{ opacity:0.85; font-size:12px; margin-left:10px; }
    .empty{ padding:10px 14px; color:#fff; opacity:.85; }
    .hints { font-size:12px; opacity:.9; margin-top:-2px; margin-bottom:8px; }
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <div class="promo-banner">
    <img src="https://img2.pic.in.th/pic/photo_--_--acf72c12141a2296.jpg" alt="‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ">
  </div>

  <div class="container">
    <img class="logo" src="https://img2.pic.in.th/pic/1735020594-1.png" alt="‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365">
    <h2>üÇ™ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ | ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365</h2>

    <input type="text" id="inviteCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ)" maxlength="20" autocomplete="one-time-code">
    <div class="hints">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πà‡∏≠ 1 ‡∏Ñ‡∏ô ‚Ä¢ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

    <input type="text" id="phone" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" maxlength="10"><br>
    <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    <div id="quotaInfo"></div>

    <div id="captureZone">
      <div id="cards"></div>
      <div id="rewardDisplay"></div>
    </div>

    <button id="captureBtn" style="display:none;">üì∏ ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</button>
  </div>

  <div class="winners">
    <div class="winners-head">üéâ ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
    <ul id="winnerList" class="winner-list"></ul>
    <div id="winnerEmpty" class="empty" style="display:none;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
  </div>

  <audio id="flipSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_72b2a6d7f8.mp3" preload="auto"></audio>
  <audio id="jackpotSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b9b19751f3.mp3" preload="auto"></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    /* ===== URL Web App ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏á ===== */
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyPfzywG1dqi9yMBcpAMthrm7Vumx-3sv6DPocYxDym22dsFPVdId6R1ig_KwSP-378/exec';

    const WIN_NUMBER = 6;
    const JACKPOT_INCLUDE_RATE = 0.30;

    const WINNER_FETCH_URL = () =>
      scriptURL + '?mode=winners&day=today&jackpot=' + WIN_NUMBER + '&t=' + Date.now();

    const WINNER_REFRESH_MS = 30000;
    let hasFlipped = false;
    let savingResult = false;           // ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ã‡πâ‡∏≥
    let currentInviteCode = '';

    /* ===== ‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏î‡∏¥‡∏° ===== */
    function loadUsedCodes(){ try{ return new Set(JSON.parse(localStorage.getItem('rr365_used_codes')||'[]')); }catch{ return new Set(); } }
    function markCodeUsed(code){ try{ const s=loadUsedCodes(); s.add(String(code||'').toUpperCase()); localStorage.setItem('rr365_used_codes', JSON.stringify([...s])); }catch{} }
    function isCodeUsedLocally(code){ return loadUsedCodes().has(String(code||'').toUpperCase()); }

    document.getElementById('startBtn').addEventListener('click', startGame);

    async function startGame() {
      const btn = document.getElementById('startBtn');
      const phone = document.getElementById("phone").value.trim();
      const codeRaw = document.getElementById("inviteCode").value.trim();
      const code = codeRaw.toUpperCase();

      if (!code) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"); return; }
      if (!/^0[0-9]{9}$/.test(phone)) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (10 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0)"); return; }
      if (isCodeUsedLocally(code)) { alert("‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"); return; }

      btn.disabled = true; const oldTxt = btn.textContent; btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
      const formData = new FormData();
      formData.append("mode", "start");
      formData.append("phone", phone);
      formData.append("code", code);

      try {
        const res = await fetch(scriptURL, { method: 'POST', body: formData });
        let data = null; try { data = await res.json(); } catch {}
        if (!data || data.ok !== true) {
          const err = data && data.error;
          if (err === 'QUOTA_EXCEEDED') alert(`‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÅ‡∏•‡πâ‡∏ß (${data.playedToday}/${data.limit})`);
          else if (err === 'CODE_NOT_FOUND') alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          else if (err === 'CODE_USED') alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)");
          else alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà/‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
          return; // ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏û‡πà
        }

        if (typeof data.limit !== 'undefined') {
          const left = Math.max(0, (data.limit || 1) - (data.playedToday || 0));
          document.getElementById('quotaInfo').textContent = `‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${left}/${data.limit || 1}`;
        }

        currentInviteCode = code;
        try { sessionStorage.setItem('rr365_code', code); } catch {}
        showCards(phone);
      } catch {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
      } finally {
        btn.disabled = false; btn.textContent = oldTxt;
      }
    }

    function showCards(phone) {
      hasFlipped = false;
      savingResult = false;
      document.getElementById("cards").style.pointerEvents = 'auto';
      document.getElementById("cards").innerHTML = "";
      document.getElementById("rewardDisplay").innerHTML = "";
      document.getElementById("captureBtn").style.display = "none";

      let numbers = [1, 2, 3, 4, 5, 5];
      if (Math.random() < JACKPOT_INCLUDE_RATE) {
        const idx = Math.floor(Math.random() * numbers.length);
        numbers[idx] = WIN_NUMBER;
      }
      numbers = shuffleArray(numbers);

      numbers.forEach(num => {
        const wrapper = document.createElement("div");
        wrapper.className = "card";

        const inner = document.createElement("div");
        inner.className = "inner-card";

        const front = document.createElement("div");
        front.className = "front"; front.textContent = "?";

        const back = document.createElement("div");
        back.className = "back";
        const label = document.createElement("span");
        label.textContent = num;
        back.appendChild(label);

        inner.appendChild(front); inner.appendChild(back);
        wrapper.appendChild(inner);

        wrapper.onclick = () => flipCard(wrapper, num, phone);
        document.getElementById("cards").appendChild(wrapper);
      });
    }

    function celebrateConfetti() {
      const duration = 2000;
      const end = Date.now() + duration;
      const defaults = { startVelocity: 35, spread: 360, ticks: 60, zIndex: 9999 };
      const iv = setInterval(() => {
        const timeLeft = end - Date.now();
        if (timeLeft <= 0) return clearInterval(iv);
        if (window.confetti) {
          window.confetti(Object.assign({}, defaults, {
            particleCount: 80 * (timeLeft / duration),
            origin: { x: Math.random(), y: Math.random() - 0.2 }
          }));
        }
      }, 200);
    }

    async function flipCard(card, number, phone) {
      if (hasFlipped) return;
      hasFlipped = true;

      document.getElementById("cards").style.pointerEvents = 'none';
      document.querySelectorAll('.card').forEach(c => c.onclick = null);

      document.getElementById('flipSound').play();
      card.classList.add("opened");

      let message = "";
      if (number === WIN_NUMBER) {
        document.getElementById('jackpotSound').play();
        celebrateConfetti();
        message = `üéâ ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç <b>${number}</b><br>üì∏ ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
        pushWinnerImmediate({phone, reward: WIN_NUMBER, ts: Date.now()});
      } else {
        message = `üò¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç <b>${number}</b><br>‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏¢‡∏±‡∏á‡∏°‡∏µ ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
      }
      document.getElementById("rewardDisplay").innerHTML = `<div class='reward-text'>${message}</div>`;
      document.getElementById("captureBtn").style.display = "inline-block";

      if (savingResult) return;
      savingResult = true;
      try {
        const code = currentInviteCode || document.getElementById('inviteCode').value.trim().toUpperCase();
        const formData = new FormData();
        formData.append("phone", phone);
        formData.append("reward", number);
        formData.append("code", code);

        const res = await fetch(scriptURL, { method: 'POST', body: formData });
        let data = null; try { data = await res.json(); } catch {}

        if (data && data.ok === true) {
          markCodeUsed(code); disableStartAfterUsed();
        } else {
          const err = data && data.error;
          if (err === 'CODE_USED') { markCodeUsed(code); disableStartAfterUsed(); alert('‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß/‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥'); }
          else if (err === 'CODE_NOT_FOUND') alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
          else if (err === 'LOCK_TIMEOUT') alert('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏≠‡∏µ‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß');
          else alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
        }
      } catch (e) {
        console.warn('save error', e);
      }
    }

    function disableStartAfterUsed(){
      const btn = document.getElementById('startBtn');
      btn.disabled = true;
      btn.textContent = '‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß';
    }

    document.getElementById("captureBtn").addEventListener("click", () => {
      html2canvas(document.getElementById("captureZone")).then(canvas => {
        const link = document.createElement("a");
        link.download = "‡∏ú‡∏•‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢365.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /* ===== LeaderBoard ===== */
    function maskPhone(p){ const s=String(p||''); if(/[xX]/.test(s)) return s; const n=s.replace(/\D/g,'').padStart(10,'0').slice(-10); return `${n.slice(0,2)}x-xxx-${n.slice(6,8)}xx`; }
    function timeAgo(ts){ try{ const t=typeof ts==='number'?ts:new Date(ts).getTime(); let d=Math.max(0,Math.floor((Date.now()-t)/1000)); if(d<60) return `${d} ‡∏ß‡∏¥`; if(d<3600) return `${Math.floor(d/60)} ‡∏ô‡∏≤‡∏ó‡∏µ`; if(d<86400) return `${Math.floor(d/3600)} ‡∏ä‡∏°.`; return `${Math.floor(d/86400)} ‡∏ß‡∏±‡∏ô`; }catch{ return '';} }
    function renderWinners(list){
      const ul=document.getElementById('winnerList'); const empty=document.getElementById('winnerEmpty');
      ul.innerHTML=''; if(!list||list.length===0){ empty.style.display='block'; return; } empty.style.display='none';
      list.forEach(w=>{
        const li=document.createElement('li');
        const left=document.createElement('div'); left.textContent=`${maskPhone(w.phone)} ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç ${w.reward}`;
        const right=document.createElement('div');
        const badge=document.createElement('span'); badge.className='badge'; badge.textContent=(w.reward===WIN_NUMBER?'JACKPOT':'‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ');
        const tm=document.createElement('span'); tm.className='time'; tm.textContent=`‚Ä¢ ${timeAgo(w.ts||Date.now())} ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        right.appendChild(badge); right.appendChild(tm); li.appendChild(left); li.appendChild(right); ul.appendChild(li);
      });
    }
    function saveWinnerCache(list){ try{ localStorage.setItem('rr365_winners_cache', JSON.stringify({ts:Date.now(), list})); }catch{} }
    function loadWinnerCache(){ try{ const raw=localStorage.getItem('rr365_winners_cache'); return raw?JSON.parse(raw).list:null; }catch{ return null; } }
    async function fetchWinners(){
      const res=await fetch(WINNER_FETCH_URL(), { cache:'no-store' });
      const ct=(res.headers.get('content-type')||'').toLowerCase();
      if(!res.ok || !ct.includes('application/json')) throw new Error('Web App ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á Anyone ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á JSON');
      const data=await res.json(); if(Array.isArray(data)){ saveWinnerCache(data); return data; } return [];
    }
    async function loadWinners(){ try{ renderWinners(await fetchWinners()); } catch(err){ console.warn(err.message||err); const c=loadWinnerCache(); if(c) renderWinners(c); } }
    function pushWinnerImmediate(entry){ const cached=loadWinnerCache()||[]; const newList=[entry,...cached].slice(0,50); saveWinnerCache(newList); renderWinners(newList); }

    document.addEventListener('DOMContentLoaded', ()=>{
      try { const s=sessionStorage.getItem('rr365_code'); if (s){ currentInviteCode=s; document.getElementById('inviteCode').value=s; } } catch {}
      loadWinners(); setInterval(loadWinners, WINNER_REFRESH_MS);
    });

    particlesJS("particles-js", {
      particles: { number:{value:60}, size:{value:4}, color:{value:"#ffd700"}, opacity:{value:0.6}, move:{speed:1.5}, line_linked:{enable:false} },
      interactivity: { events: { onhover: { enable: false } } }
    });
  </script>
</body>
</html>
