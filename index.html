<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
  <style>
    body{font-family:system-ui;background:#0b0b0b;color:#fff;margin:0;padding:24px}
    .card{max-width:520px;margin:0 auto;background:#141414;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    h1{font-size:20px;margin:0 0 8px}
    p{opacity:.85;margin:0 0 14px;line-height:1.55}
    label{display:block;margin:10px 0 6px;opacity:.9}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f0f0f;color:#fff;font-size:16px}
    button{width:100%;padding:12px 14px;border-radius:12px;border:0;background:#ff2b2b;color:#fff;font-size:16px;font-weight:700;cursor:pointer;margin-top:12px}
    button:disabled{opacity:.55;cursor:not-allowed}
    .msg{margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);white-space:pre-line;display:none}
    .ok{border-color:rgba(0,255,140,.25)}
    .err{border-color:rgba(255,60,60,.35)}
    .small{font-size:12px;opacity:.7;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>üìå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
    <p>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå / 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ‡πÅ‡∏•‡∏∞ 1 ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå / 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>

    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
    <input id="phone" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0631087044" />

    <button id="btnCheck">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
    <button id="btnJoin" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>

    <div id="msg" class="msg"></div>
    <div class="small">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏°‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</div>
  </div>

<script>
  const DEVICE_JOIN_KEY = "rr365_joined_activity";
  const DEVICE_ID_KEY   = "rr365_device_id";

  const phone = document.getElementById("phone");
  const btnCheck = document.getElementById("btnCheck");
  const btnJoin = document.getElementById("btnJoin");
  const msg = document.getElementById("msg");

  function show(text, type="ok"){
    msg.style.display = "block";
    msg.className = "msg " + (type==="err" ? "err" : "ok");
    msg.textContent = text;
  }

  function normalizePhone(v){
    let p = (v||"").replace(/\D/g,"");
    if (p.startsWith("66")) p = "0"+p.slice(2);
    if (p.length === 9) p = "0"+p;
    if (p.length === 10 && p.startsWith("0")) return p;
    return "";
  }

  function deviceAlreadyJoined(){
    return localStorage.getItem(DEVICE_JOIN_KEY) === "1";
  }
  function markDeviceJoined(){
    localStorage.setItem(DEVICE_JOIN_KEY, "1");
  }
  function getOrCreateDeviceId(){
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if (!id){
      id = "dev_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem(DEVICE_ID_KEY, id);
    }
    return id;
  }

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢
  if (deviceAlreadyJoined()){
    document.body.innerHTML = `
      <div style="max-width:520px;margin:80px auto;background:#141414;color:#fff;border-radius:16px;
      padding:24px;text-align:center;border:1px solid rgba(255,60,60,.35);font-family:system-ui">
        <h2 style="margin:0 0 10px">‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
        <p style="margin:0;line-height:1.7">
          ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß<br>
          ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
        </p>
      </div>
    `;
  }

  function runCheck(){
    const p = normalizePhone(phone.value);
    if (!p) return show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 0631087044)", "err");

    btnCheck.disabled = true; btnJoin.disabled = true;

    google.script.run
      .withSuccessHandler((res)=>{
        btnCheck.disabled = false;

        if (!res || !res.ok) return show((res&&res.msg)||"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "err");

        if (res.exists){
          show("‚ö†Ô∏è ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)", "err");
          btnJoin.disabled = true;
        } else {
          show("‚úÖ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢", "ok");
          btnJoin.disabled = false;
        }
      })
      .withFailureHandler((err)=>{
        btnCheck.disabled = false;
        show("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ù‡∏±‡πà‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "err");
      })
      .apiCheck(p, getOrCreateDeviceId(), navigator.userAgent);
  }

  function runRegister(){
    const p = normalizePhone(phone.value);
    if (!p) return show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "err");

    btnCheck.disabled = true; btnJoin.disabled = true;

    google.script.run
      .withSuccessHandler((res)=>{
        btnCheck.disabled = false;

        if (!res || !res.ok) return show((res&&res.msg)||"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "err");

        if (res.registered){
          markDeviceJoined();
          show("üéâ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß", "ok");
          btnJoin.disabled = true;
        } else {
          show(res.msg || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ", "err");
          btnJoin.disabled = true;
        }
      })
      .withFailureHandler((err)=>{
        btnCheck.disabled = false;
        show("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ù‡∏±‡πà‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "err");
      })
      .apiRegister(p, getOrCreateDeviceId(), navigator.userAgent);
  }

  btnCheck.addEventListener("click", runCheck);
  btnJoin.addEventListener("click", runRegister);
</script>
</body>
</html>
