<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 | OLD_ADMIN_V2</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{--bg:#0b0b0b;--line:rgba(255,255,255,.12);--txt:#fff;--muted:#cfcfcf;--accent:#ff2b2b;--accent2:#b80000}
*{box-sizing:border-box}
body{margin:0;padding:18px;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;background:radial-gradient(900px 500px at 50% -10%, rgba(255,60,60,.15), transparent 60%), var(--bg);color:var(--txt)}
.card{max-width:1100px;margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.6)}
h1{margin:0 0 10px;font-size:18px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
input,select,textarea{background:#0f0f0f;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:#fff;font-size:14px}
textarea{width:100%;min-height:110px;resize:vertical}
.btn{padding:10px 12px;border:0;border-radius:12px;cursor:pointer;font-weight:900;color:#fff}
.btnMain{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btnAlt{background:#2a2a2a}
.btnOk{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btnBad{background:linear-gradient(135deg,#ff5a5f,#c81e1e)}
.btnBlue{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.btnWarn{background:linear-gradient(135deg,#f59e0b,#d97706)}
.small{color:var(--muted);font-size:12px;line-height:1.6}
.hr{height:1px;background:var(--line);margin:12px 0}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th{color:#ddd;font-size:12px;text-align:left;padding:0 10px}
tr{background:rgba(0,0,0,.25)}
td{padding:10px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
td:first-child{border-left:1px solid rgba(255,255,255,.06);border-radius:12px 0 0 12px}
td:last-child{border-right:1px solid rgba(255,255,255,.06);border-radius:0 12px 12px 0}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid rgba(255,255,255,.15)}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:900;letter-spacing:.5px}
.msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);white-space:pre-line;display:none;line-height:1.6}
</style>
</head>
<body>
<div class="card">
  <h1>üõ°Ô∏è ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 (OLD_ADMIN_V2)</h1>

  <div class="row">
    <div style="flex:2;min-width:280px">
      <div class="small">SCRIPT_URL (/exec ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ)</div>
      <input id="scriptUrl" style="width:100%" placeholder="https://script.google.com/macros/s/.../exec">
    </div>
    <div style="flex:1;min-width:220px">
      <div class="small">ADMIN_TOKEN (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö V2_ADMIN_TOKEN ‡πÉ‡∏ô Code.gs)</div>
      <input id="adminToken" style="width:100%" placeholder="RR365-OLD-ADMIN-CHANGE-ME-2026">
    </div>
    <button class="btn btnMain" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="btn btnAlt" id="btnLoad">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  </div>

  <div class="row" style="margin-top:10px;align-items:center">
    <div>
      <div class="small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
      <select id="statusFilter">
        <option value="PENDING" selected>PENDING (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
        <option value="APPROVED">APPROVED</option>
        <option value="REJECTED">REJECTED</option>
        <option value="USED">USED</option>
      </select>
    </div>
    <div style="flex:1;min-width:240px">
      <div class="small">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</div>
      <input id="q" style="width:100%" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0611 ‡∏´‡∏£‡∏∑‡∏≠ 9999">
    </div>
    <button class="btn btnBlue" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <div id="msg" class="msg"></div>
  <div class="hr"></div>

  <table class="table">
    <thead>
      <tr>
        <th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÇ‡∏Ñ‡πâ‡∏î</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="hr"></div>
  <div class="small">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ pool (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î)</div>
  <textarea id="codes" placeholder="RR1234&#10;RR5678&#10;RR9999"></textarea>
  <div class="row" style="margin-top:10px">
    <button class="btn btnOk" id="btnAddCodes">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ v2_codes</button>
    <div class="small" style="flex:1">* ‡∏´‡∏ô‡πâ‡∏≤ admin ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
  </div>
</div>

<script>
const LS_URL="RR365_OLDV2_ADMIN_SCRIPT_URL";
const LS_TOK="RR365_OLDV2_ADMIN_TOKEN";
const $=id=>document.getElementById(id);

const $scriptUrl=$("scriptUrl");
const $adminToken=$("adminToken");
const $status=$("statusFilter");
const $q=$("q");
const $tbody=$("tbody");
const $msg=$("msg");
const $codes=$("codes");

function showMsg(t){ $msg.style.display="block"; $msg.textContent=t; }
function hideMsg(){ $msg.style.display="none"; $msg.textContent=""; }

function jsonp(url, params){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    params.callback=cb; params._ts=Date.now();
    const s=document.createElement("script");
    s.src=url+"?"+new URLSearchParams(params).toString();
    window[cb]=(d)=>{ try{delete window[cb];}catch(_){window[cb]=undefined;} s.remove(); res(d); };
    s.onerror=()=>{ try{delete window[cb];}catch(_){window[cb]=undefined;} s.remove(); rej(new Error("JSONP")); };
    document.body.appendChild(s);
  });
}

function cfg(){
  const url=$scriptUrl.value.trim();
  const tok=$adminToken.value.trim();
  if(!url) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SCRIPT_URL (/exec)");
  if(!tok) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ADMIN_TOKEN");
  return {url,tok};
}
function mask(p){
  p=String(p||""); if(p.length<10) return "0XXXXXXXXX";
  return p.slice(0,3)+"XXXX"+p.slice(-3);
}

async function loadList(){
  hideMsg(); $tbody.innerHTML="";
  let c; try{c=cfg();}catch(e){showMsg(e.message);return;}
  showMsg("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
  const d=await jsonp(c.url,{action:"admin_list",admin_token:c.tok,status:$status.value}).catch(()=>null);
  if(!d){showMsg("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ Deploy: Anyone / ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå /exec)");return;}
  if(!d.ok){showMsg(d.msg||"‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå");return;}
  let items=Array.isArray(d.items)?d.items:[];
  const q=($q.value||"").trim();
  if(q) items=items.filter(x=>String(x.phone||"").includes(q));
  if(!items.length){showMsg("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ");return;}
  hideMsg();

  $tbody.innerHTML=items.map((x,i)=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString("th-TH"):"-";
    const promo=x.promo_code?`<span class="code">${x.promo_code}</span>`:"-";
    return `
      <tr>
        <td>${i+1}<br><small>#row ${x.row}</small></td>
        <td>${t}</td>
        <td title="${x.phone}">${mask(x.phone)}</td>
        <td><span class="badge">${x.status}</span></td>
        <td>${promo}</td>
        <td>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btnOk" onclick="approve(${x.row})">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="btn btnBad" onclick="reject(${x.row})">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
            <button class="btn btnBlue" onclick="used(${x.row})">USED</button>
            <button class="btn btnWarn" onclick="resetRow(${x.row})">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô PENDING</button>
          </div>
        </td>
      </tr>`;
  }).join("");
}

async function callAdmin(action, extra){
  let c; try{c=cfg();}catch(e){showMsg(e.message);return null;}
  const d=await jsonp(c.url,Object.assign({action,admin_token:c.tok},extra||{})).catch(()=>null);
  if(!d){showMsg("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");return null;}
  if(!d.ok){showMsg(d.msg||"‚ùå ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");return null;}
  showMsg(d.msg||"‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  return d;
}

window.approve=async(row)=>{ if(!confirm("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ?"))return; const d=await callAdmin("admin_approve",{row}); if(d) loadList(); };
window.reject =async(row)=>{ if(!confirm("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ?"))return; const d=await callAdmin("admin_reject",{row}); if(d) loadList(); };
window.used   =async(row)=>{ if(!confirm("‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô USED?"))return; const d=await callAdmin("admin_used",{row}); if(d) loadList(); };
window.resetRow=async(row)=>{ if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô PENDING + ‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î?"))return; const d=await callAdmin("admin_reset",{row}); if(d) loadList(); };

$("btnSave").onclick=()=>{
  localStorage.setItem(LS_URL,$scriptUrl.value.trim());
  localStorage.setItem(LS_TOK,$adminToken.value.trim());
  showMsg("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
};
$("btnLoad").onclick=()=>{ loadCfg(); loadList(); };
$("btnRefresh").onclick=loadList;

$("btnAddCodes").onclick=async()=>{
  const text=($codes.value||"").trim();
  if(!text){showMsg("‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô");return;}
  if(!confirm("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ v2_codes?"))return;
  const d=await callAdmin("admin_add_codes",{codes:text});
  if(d){ $codes.value=""; }
};

function loadCfg(){
  $scriptUrl.value=localStorage.getItem(LS_URL)||"";
  $adminToken.value=localStorage.getItem(LS_TOK)||"";
}
loadCfg();
</script>
</body>
</html>
