<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RR365 Admin | ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{
  --bg:#0b0b0b; --card:#141414; --line:rgba(255,255,255,.12);
  --txt:#fff; --muted:#cfcfcf;
  --accent:#ff2b2b; --accent2:#b80000;
  --ok:#36d399; --bad:#ff5a5f;
}
*{box-sizing:border-box}
body{
  margin:0;padding:18px;
  font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
  background:radial-gradient(900px 500px at 50% -10%, rgba(255,60,60,.15), transparent 60%), var(--bg);
  color:var(--txt);
}
.card{
  max-width:980px;margin:0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid var(--line); border-radius:22px; padding:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.6);
}
h1{font-size:18px;margin:0 0 10px}
.top{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  margin-bottom:12px;
}
input, select, textarea{
  background:#0f0f0f; color:#fff; border:1px solid var(--line);
  border-radius:14px; padding:10px 12px; outline:none;
}
.btn{
  border:0; border-radius:14px; padding:10px 12px;
  font-weight:900; color:#fff; cursor:pointer;
}
.btnMain{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btnAlt{background:#2a2a2a}
.btnOk{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btnBad{background:linear-gradient(135deg,#ff5a5f,#b91c1c)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.msg{
  margin:10px 0 12px; padding:10px 12px; border-radius:14px;
  border:1px solid var(--line); background:rgba(0,0,0,.25); display:none;
  white-space:pre-line;
}
.msg.ok{border-color:rgba(54,211,153,.4)}
.msg.err{border-color:rgba(255,90,95,.45)}
table{width:100%; border-collapse:separate; border-spacing:0 10px;}
th{color:var(--muted); text-align:left; font-size:12px; font-weight:800; padding:0 10px;}
tr{
  background:rgba(0,0,0,.25);
  border:1px solid var(--line);
}
td{
  padding:12px 10px; border-top:1px solid var(--line); border-bottom:1px solid var(--line);
}
tr td:first-child{border-left:1px solid var(--line); border-radius:14px 0 0 14px;}
tr td:last-child{border-right:1px solid var(--line); border-radius:0 14px 14px 0;}
.badge{
  font-size:12px; font-weight:900; padding:6px 10px; border-radius:999px;
  display:inline-block; border:1px solid var(--line);
}
.PENDING{background:rgba(255,255,255,.06)}
.APPROVED{background:rgba(54,211,153,.16); border-color:rgba(54,211,153,.35)}
.REJECTED{background:rgba(255,90,95,.16); border-color:rgba(255,90,95,.35)}
.USED{background:rgba(59,130,246,.16); border-color:rgba(59,130,246,.35)}
.small{font-size:12px;color:var(--muted)}
.actions{display:flex; gap:8px; flex-wrap:wrap}
textarea{width:100%; min-height:80px; resize:vertical}
hr{border:0;border-top:1px solid var(--line); margin:14px 0}
</style>
</head>
<body>
<div class="card">
  <h1>üõ°Ô∏è RR365 Admin (‡πÅ‡∏¢‡∏Å) ‚Äî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/USED/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</h1>

  <div class="top">
    <input id="key" placeholder="ADMIN KEY" style="min-width:260px"/>
    <select id="status">
      <option value="PENDING">PENDING</option>
      <option value="APPROVED">APPROVED</option>
      <option value="REJECTED">REJECTED</option>
      <option value="USED">USED</option>
      <option value="ALL">ALL</option>
    </select>
    <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 061" />
    <button class="btn btnMain" id="btnLoad" type="button">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="btn btnAlt" id="btnRefresh" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <div id="msg" class="msg"></div>

  <table>
    <thead>
      <tr>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡πÇ‡∏Ñ‡πâ‡∏î</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <hr>

  <h1 style="margin:0 0 10px">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏µ‡∏ó codes</h1>
  <div class="small">‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‚Äù</div>
  <div style="margin-top:10px">
    <textarea id="codes"></textarea>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
      <button class="btn btnOk" id="btnAddCodes" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
      <button class="btn btnAlt" id="btnClearCodes" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á</button>
    </div>
  </div>
</div>

<script>
/* üî¥ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå WebApp ‡∏Ç‡∏≠‡∏á "‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà" */
const ADMIN_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwbM-jL7lKFuJTQyoVc7u_LKPkBhiBAxnKNi0gWxtgwhVdUQvQKCuCDEiBHMW2bZ-3MSg/exec";

const $key = document.getElementById("key");
const $status = document.getElementById("status");
const $q = document.getElementById("q");
const $btnLoad = document.getElementById("btnLoad");
const $btnRefresh = document.getElementById("btnRefresh");
const $tbody = document.getElementById("tbody");
const $msg = document.getElementById("msg");
const $codes = document.getElementById("codes");
const $btnAddCodes = document.getElementById("btnAddCodes");
const $btnClearCodes = document.getElementById("btnClearCodes");

function showMsg(t, type="ok"){
  $msg.style.display="block";
  $msg.className="msg "+(type==="err"?"err":"ok");
  $msg.textContent=t;
}
function hideMsg(){ $msg.style.display="none"; $msg.textContent=""; }

function jsonp(params){
  return new Promise((res, rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    params.callback = cb;
    params._ts = Date.now();
    const s=document.createElement("script");
    s.src = ADMIN_SCRIPT_URL + "?" + new URLSearchParams(params).toString();
    window[cb]=(d)=>{ try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); res(d); };
    s.onerror=()=>{ try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); rej(new Error("JSONP_ERROR")); };
    document.body.appendChild(s);
  });
}

function fmtTime(iso){
  if(!iso) return "-";
  try{
    const d = new Date(iso);
    return d.toLocaleString("th-TH");
  }catch(_){ return iso; }
}

function rowHtml(r){
  const st = r.status || "UNKNOWN";
  const code = r.promo_code || "";
  const note = r.note || "";
  return `
  <tr>
    <td>${fmtTime(r.created_at)}</td>
    <td><b>${r.phone || ""}</b></td>
    <td><span class="badge ${st}">${st}</span></td>
    <td>${code ? `<b>${code}</b>` : "-"}</td>
    <td class="small">${note ? note : "-"}</td>
    <td>
      <div class="actions">
        <button class="btn btnOk" data-act="approve" data-phone="${r.phone}">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
        <button class="btn btnBad" data-act="reject" data-phone="${r.phone}">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        <button class="btn btnAlt" data-act="used" data-phone="${r.phone}">‡∏ï‡∏±‡πâ‡∏á USED</button>
      </div>
    </td>
  </tr>`;
}

async function loadList(){
  hideMsg();
  $tbody.innerHTML = "";
  const key = $key.value.trim();
  if(!key){ showMsg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ADMIN KEY", "err"); return; }

  showMsg("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...");
  const d = await jsonp({
    action:"list",
    key,
    status:$status.value,
    q:$q.value.trim()
  }).catch(()=>null);

  if(!d || !d.ok){
    showMsg((d && d.msg) ? d.msg : "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ ADMIN_SCRIPT_URL/Deploy)", "err");
    return;
  }

  const rows = d.rows || [];
  if(!rows.length){
    showMsg("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", "ok");
    return;
  }

  $tbody.innerHTML = rows.map(rowHtml).join("");
  showMsg("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: " + rows.length + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "ok");
}

async function act(phone, action){
  hideMsg();
  const key = $key.value.trim();
  if(!key){ showMsg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ADMIN KEY", "err"); return; }

  if(action==="reject"){
    const reason = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ/‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ):","‡∏ù‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á / ‡∏ã‡πâ‡∏≥ / ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç");
    const d = await jsonp({action:"reject", key, phone, reason: reason || ""}).catch(()=>null);
    if(!d || !d.ok){ showMsg((d&&d.msg)||"‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","err"); return; }
    showMsg("‚úÖ " + (d.msg||"‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß"), "ok");
    await loadList();
    return;
  }

  const d = await jsonp({action, key, phone}).catch(()=>null);
  if(!d || !d.ok){ showMsg((d&&d.msg)||"‚ùå ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","err"); return; }
  showMsg("‚úÖ " + (d.msg||"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") + (d.promo_code?("\n‡πÇ‡∏Ñ‡πâ‡∏î: "+d.promo_code):""), "ok");
  await loadList();
}

document.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;
  const action = btn.getAttribute("data-act");
  const phone  = btn.getAttribute("data-phone");
  act(phone, action);
});

$btnLoad.onclick = loadList;
$btnRefresh.onclick = loadList;

$btnAddCodes.onclick = async()=>{
  hideMsg();
  const key = $key.value.trim();
  if(!key){ showMsg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ADMIN KEY", "err"); return; }
  const text = $codes.value.trim();
  if(!text){ showMsg("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô", "err"); return; }

  showMsg("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î...");
  const d = await jsonp({action:"addCodes", key, codes:text}).catch(()=>null);
  if(!d || !d.ok){ showMsg((d&&d.msg)||"‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","err"); return; }
  showMsg("‚úÖ " + (d.msg||"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß"), "ok");
  $codes.value = "";
};

$btnClearCodes.onclick = ()=>{ $codes.value=""; };
</script>
</body>
</html>
