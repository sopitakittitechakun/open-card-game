<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 (‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ)</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{--bg:#0b0b0b;--line:rgba(255,255,255,.12);--txt:#fff;--muted:#cfcfcf;--accent:#ff2b2b;--accent2:#b80000}
*{box-sizing:border-box}
body{margin:0;padding:18px;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;background:radial-gradient(900px 500px at 50% -10%, rgba(255,60,60,.15), transparent 60%), var(--bg);color:var(--txt)}
.card{max-width:1200px;margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.6)}
h1{margin:0 0 10px;font-size:18px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
input,select,textarea{background:#0f0f0f;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:#fff;font-size:14px}
textarea{width:100%;min-height:110px;resize:vertical}
.btn{padding:10px 12px;border:0;border-radius:12px;cursor:pointer;font-weight:900;color:#fff}
.btnMain{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btnAlt{background:#2a2a2a}
.btnOk{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btnBlue{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.btnWarn{background:linear-gradient(135deg,#f59e0b,#d97706)}
.small{color:var(--muted);font-size:12px;line-height:1.6}
.hr{height:1px;background:var(--line);margin:12px 0}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th{color:#ddd;font-size:12px;text-align:left;padding:0 10px}
tr{background:rgba(0,0,0,.25)}
td{padding:10px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
td:first-child{border-left:1px solid rgba(255,255,255,.06);border-radius:12px 0 0 12px}
td:last-child{border-right:1px solid rgba(255,255,255,.06);border-radius:0 12px 12px 0}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid rgba(255,255,255,.15)}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:900;letter-spacing:.5px}
.msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);white-space:pre-line;display:none;line-height:1.6}
.actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="card">
  <h1>üõ°Ô∏è ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 (‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ)</h1>

  <div class="row">
    <div style="flex:2;min-width:360px">
      <div class="small">SCRIPT_URL (‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏Ç‡∏≠‡∏á Web App)</div>
      <input id="scriptUrl" style="width:100%" placeholder="https://script.google.com/macros/s/AKfycbwjoy-R5BSxkM5FbwQRnF_dv95gM3CRPejckWx5vrued5SS9WIXKZzZ1iV6NFKHeJWHxg/exec">
    </div>
    <div style="flex:1;min-width:280px">
      <div class="small">ADMIN_TOKEN (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Code.gs)</div>
      <input id="token" style="width:100%" placeholder="RR365-ADMIN-CHANGE-ME-2026">
    </div>
    <button class="btn btnMain" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="btn btnAlt" id="btnLoad">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="btn btnAlt" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <div class="small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</div>
      <select id="status">
        <option value="PENDING" selected>PENDING (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
        <option value="APPROVED">APPROVED</option>
        <option value="REJECTED">REJECTED</option>
        <option value="USED">USED</option>
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>
    </div>
    <div style="flex:1;min-width:260px">
      <div class="small">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</div>
      <input id="q" style="width:100%" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0611 ‡∏´‡∏£‡∏∑‡∏≠ 9999">
    </div>
    <div style="min-width:260px">
      <div class="small">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô (‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏ï‡πá‡∏°)</div>
      <input id="phone" style="width:100%" placeholder="0611111111">
    </div>
    <button class="btn btnOk" id="btnApproveOne">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
    <button class="btn btnAlt" id="btnRejectOne">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
    <button class="btn btnWarn" id="btnUsedOne">‡∏ï‡∏±‡πâ‡∏á USED</button>
    <button class="btn btnBlue" id="btnResetOne">‡∏õ‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô PENDING</button>
  </div>

  <div id="msg" class="msg"></div>

  <div class="hr"></div>

  <table class="table">
    <thead>
      <tr>
        <th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÇ‡∏Ñ‡πâ‡∏î</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="hr"></div>
  <div class="small">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ codes (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î) ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÉ‡∏´‡πâ</div>
  <textarea id="codes" placeholder="RR1234&#10;RR5678&#10;RR9999"></textarea>
  <div class="row" style="margin-top:10px">
    <button class="btn btnOk" id="btnAddCodes">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
    <label class="small" style="display:flex;align-items:center;gap:8px">
      <input id="clearCode" type="checkbox" style="width:auto"> ‡∏ï‡∏≠‡∏ô ‚Äú‡∏õ‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô PENDING‚Äù ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢
    </label>
  </div>

  <div class="small" style="margin-top:10px">
    * ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå admin.html ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö (‡∏°‡∏µ token)<br>
    * ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô token ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á Code.gs ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  </div>
</div>

<script>
const LS="RR365_ADMIN_API_V1";
const $=id=>document.getElementById(id);

let SCRIPT_URL="";

function save(){
  localStorage.setItem(LS, JSON.stringify({
    scriptUrl:$("scriptUrl").value.trim(),
    token:$("token").value.trim()
  }));
  show("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
}
function load(){
  const raw=localStorage.getItem(LS);
  if(!raw) return;
  try{
    const o=JSON.parse(raw);
    if(o.scriptUrl) $("scriptUrl").value=o.scriptUrl;
    if(o.token) $("token").value=o.token;
  }catch(_){}
}
load();

function show(t){ $("msg").style.display="block"; $("msg").textContent=t; }
function hide(){ $("msg").style.display="none"; $("msg").textContent=""; }

function normalizePhone(v){
  let s=String(v||"").trim(); const th="‡πê‡πë‡πí‡πì‡πî‡πï‡πñ‡πó‡πò‡πô";
  for(let i=0;i<th.length;i++) s=s.replace(new RegExp(th[i],"g"),String(i));
  let p=s.replace(/\D/g,"");
  if(p.startsWith("0066")) p=p.slice(2);
  if(p.startsWith("66")) p="0"+p.slice(2);
  if(!p.startsWith("0") && p.length===9) p="0"+p;
  return /^0[689]\d{8}$/.test(p)?p:"";
}

function jsonp(params){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    params.callback=cb;
    params._ts=Date.now();

    const s=document.createElement("script");
    s.src = SCRIPT_URL + "?" + new URLSearchParams(params).toString();

    window[cb]=(d)=>{ try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); res(d); };
    s.onerror=()=>{ try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); rej(new Error("JSONP_ERROR")); };

    document.body.appendChild(s);
  });
}

function mask(p){
  p=String(p||""); if(p.length<10) return "0XXXXXXXXX";
  return p.slice(0,3)+"XXXX"+p.slice(-3);
}

async function loadList(){
  hide();
  SCRIPT_URL=$("scriptUrl").value.trim();
  const token=$("token").value.trim();
  const status=$("status").value.trim();
  const q=$("q").value.trim();

  if(!SCRIPT_URL || !token){ show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SCRIPT_URL ‡πÅ‡∏•‡∏∞ ADMIN_TOKEN"); return; }

  show("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
  const d=await jsonp({action:"admin_list", token, status, q}).catch(()=>null);
  if(!d){ show("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ Deploy /exec)"); return; }
  if(!d.ok){ show(d.msg || "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }

  const items=d.items||[];
  if(!items.length){ show("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ"); $("tbody").innerHTML=""; return; }
  hide();

  $("tbody").innerHTML = items.map((x,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${x.created_at||"-"}</td>
      <td title="${x.phone}">${mask(x.phone)}</td>
      <td><span class="badge">${x.status||"-"}</span></td>
      <td><span class="code">${x.promo_code||"-"}</span></td>
      <td>${(x.note||"")}</td>
      <td>
        <div class="actions">
          <button class="btn btnOk"   onclick="act('admin_approve','${x.phone}')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="btn btnAlt"  onclick="act('admin_reject','${x.phone}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          <button class="btn btnWarn" onclick="act('admin_mark_used','${x.phone}')">USED</button>
          <button class="btn btnBlue" onclick="act('admin_reset','${x.phone}')">‡∏õ‡∏•‡∏î</button>
        </div>
      </td>
    </tr>
  `).join("");
}

async function act(action, phone){
  SCRIPT_URL=$("scriptUrl").value.trim();
  const token=$("token").value.trim();
  if(!SCRIPT_URL || !token){ show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SCRIPT_URL ‡πÅ‡∏•‡∏∞ ADMIN_TOKEN"); return; }

  const p=normalizePhone(phone);
  if(!p){ show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }

  const clear_code = $("clearCode").checked ? "1" : "0";
  show("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...");
  const d=await jsonp({action, token, phone:p, clear_code, codes:$("codes").value}).catch(()=>null);
  if(!d){ show("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
  show(d.msg || "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  await loadList();
}

$("btnSave").onclick=save;
$("btnLoad").onclick=loadList;
$("btnRefresh").onclick=loadList;

$("btnApproveOne").onclick=()=>act("admin_approve",$("phone").value);
$("btnRejectOne").onclick =()=>act("admin_reject",$("phone").value);
$("btnUsedOne").onclick   =()=>act("admin_mark_used",$("phone").value);
$("btnResetOne").onclick  =()=>act("admin_reset",$("phone").value);

$("btnAddCodes").onclick  =()=>act("admin_add_codes", $("phone").value || "0611111111"); // phone ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô normalize (‡πÉ‡∏ä‡πâ dummy ‡πÑ‡∏î‡πâ)
</script>
</body>
</html>
