<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 | ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{
  --bg:#0b0b0b; --card:#141414; --line:rgba(255,255,255,.12);
  --txt:#fff; --muted:#cfcfcf;
  --accent:#ff2b2b; --accent2:#b80000;
  --ok:#36d399; --bad:#ff5a5f;
}
*{box-sizing:border-box}
body{
  margin:0;padding:22px;
  font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
  background:radial-gradient(900px 500px at 50% -10%, rgba(255,60,60,.15), transparent 60%), var(--bg);
  color:var(--txt);
}
.card{
  max-width:1100px;margin:0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid var(--line); border-radius:22px; padding:16px;
  box-shadow:0 18px 48px rgba(0,0,0,.65);
}
h1{margin:0 0 12px;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:860px){ .grid{grid-template-columns:1fr} }
label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
input,select,textarea{
  width:100%;padding:12px 12px;border-radius:14px;
  border:1px solid var(--line);background:#0f0f0f;color:#fff;font-size:14px;
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
button{
  padding:11px 14px;border-radius:14px;border:0;
  font-size:14px;font-weight:900;color:#fff;cursor:pointer;
}
.btnAlt{background:#2a2a2a}
.btnMain{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btnGood{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btnBlue{background:linear-gradient(135deg,#3b82f6,#2563eb)}
button:disabled{opacity:.55;cursor:not-allowed}
.msg{
  margin-top:10px;padding:12px;border-radius:14px;
  border:1px solid var(--line);background:rgba(0,0,0,.25);
  white-space:pre-line;display:none;line-height:1.6;font-size:14px;
}
.ok{border-color:rgba(54,211,153,.4)}
.err{border-color:rgba(255,90,95,.45)}
hr{border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0}
.tableWrap{
  margin-top:12px;border:1px solid rgba(255,255,255,.12);
  border-radius:16px; overflow:hidden;
}
table{width:100%;border-collapse:collapse;background:rgba(0,0,0,.25)}
th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:top}
th{background:rgba(255,255,255,.06);text-align:left;color:#eaeaea}
td small{color:#bfbfbf}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);font-size:12px}
.pPENDING{border-color:rgba(255,255,255,.22)}
.pAPPROVED{border-color:rgba(54,211,153,.55)}
.pREJECTED{border-color:rgba(255,90,95,.55)}
.pUSED{border-color:rgba(59,130,246,.55)}
.hint{color:#bfbfbf;font-size:12px;line-height:1.6}
kbd{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);padding:2px 6px;border-radius:8px}
</style>
</head>
<body>
<div class="card">
  <h1>üõ°Ô∏è ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365</h1>

  <div class="grid">
    <div>
      <label>SCRIPT_URL (‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå ‚Äú‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏î‚Äù)</label>
      <input id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec"/>
    </div>
    <div>
      <label>ADMIN_TOKEN (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Code.gs)</label>
      <input id="adminToken" placeholder="RR365-ADMIN-CHANGE-ME-2026"/>
    </div>
  </div>

  <div class="grid" style="margin-top:6px">
    <div>
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</label>
      <select id="status">
        <option value="PENDING">PENDING (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
        <option value="APPROVED">APPROVED (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option>
        <option value="REJECTED">REJECTED (‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò)</option>
        <option value="USED">USED (‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)</option>
      </select>
    </div>
    <div>
      <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ)</label>
      <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0611 ‡∏´‡∏£‡∏∑‡∏≠ 9999"/>
    </div>
  </div>

  <div class="row">
    <button id="btnSave" class="btnMain" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="btnLoad" class="btnAlt" type="button">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button id="btnRefresh" class="btnBlue" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <div id="msg" class="msg"></div>

  <hr>

  <div class="grid">
    <div>
      <div class="hint">
        ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
        <br>‚Ä¢ <kbd>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</kbd> = ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô pool)
        <br>‚Ä¢ <kbd>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</kbd> = REJECTED
        <br>‚Ä¢ <kbd>USED</kbd> = ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
        <br>‚Ä¢ <kbd>‡∏õ‡∏•‡∏î‡∏ú‡∏π‡∏Å/‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô</kbd> = ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå bind + ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå blacklist (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
      </div>
    </div>
    <div>
      <label>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ pool (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î)</label>
      <textarea id="codes" placeholder="RR1234&#10;RR5678&#10;RR9999"></textarea>
      <div class="row">
        <button id="btnAddCodes" class="btnGood" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ codes</button>
      </div>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:70px">#row</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡πÇ‡∏Ñ‡πâ‡∏î</th>
          <th style="width:360px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6"><small>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù</small></td></tr>
      </tbody>
    </table>
  </div>

  <div class="hint" style="margin-top:10px">
    * ‡∏´‡∏ô‡πâ‡∏≤ admin ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
  </div>
</div>

<script>
/* ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ====== */
const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw9tzFhtaXMIhWpuhGUYorzLPn6sLuZj41b9T4fiYxAp4t8LHMjvhJHKVLsRcY7mJmIQ/exec";
const DEFAULT_ADMIN_TOKEN = "RR365-ADMIN-CHANGE-ME-2026";

/* ====== UI ====== */
const $scriptUrl = document.getElementById("scriptUrl");
const $adminToken = document.getElementById("adminToken");
const $status = document.getElementById("status");
const $q = document.getElementById("q");
const $msg = document.getElementById("msg");
const $tbody = document.getElementById("tbody");
const $codes = document.getElementById("codes");

const $btnSave = document.getElementById("btnSave");
const $btnLoad = document.getElementById("btnLoad");
const $btnRefresh = document.getElementById("btnRefresh");
const $btnAddCodes = document.getElementById("btnAddCodes");

function show(t,type="ok"){
  $msg.style.display="block";
  $msg.className="msg "+(type==="err"?"err":"ok");
  $msg.textContent=t;
}
function hideMsg(){ $msg.style.display="none"; $msg.textContent=""; }

function saveLocal(){
  localStorage.setItem("RR365_ADMIN_SCRIPT_URL", $scriptUrl.value.trim());
  localStorage.setItem("RR365_ADMIN_TOKEN", $adminToken.value.trim());
  show("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß","ok");
}
function loadLocal(){
  $scriptUrl.value = localStorage.getItem("RR365_ADMIN_SCRIPT_URL") || DEFAULT_SCRIPT_URL;
  $adminToken.value = localStorage.getItem("RR365_ADMIN_TOKEN") || DEFAULT_ADMIN_TOKEN;
}
loadLocal();

/* ====== JSONP ====== */
function jsonp(url, params){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    params.callback=cb;
    params._ts=Date.now();

    const s=document.createElement("script");
    s.src = url + "?" + new URLSearchParams(params).toString();

    window[cb]=(d)=>{ try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); res(d); };
    s.onerror=()=>{ try{ delete window[cb]; }catch(_){ window[cb]=undefined; } s.remove(); rej(new Error("JSONP_ERROR")); };

    document.body.appendChild(s);
  });
}

function getCfg(){
  const url = $scriptUrl.value.trim();
  const token = $adminToken.value.trim();
  if(!url) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SCRIPT_URL (/exec)");
  if(!token) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ADMIN_TOKEN");
  return { url, token };
}

function pill(status){
  const s = String(status||"").toUpperCase();
  return `<span class="pill p${s}">${s}</span>`;
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

async function loadList(){
  hideMsg();
  $tbody.innerHTML = `<tr><td colspan="6"><small>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</small></td></tr>`;
  let cfg;
  try{ cfg = getCfg(); }catch(e){
    $tbody.innerHTML = `<tr><td colspan="6"><small>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</small></td></tr>`;
    show(e.message,"err"); return;
  }

  const d = await jsonp(cfg.url, {
    action:"admin_list",
    admin_token: cfg.token,
    status: $status.value
  }).catch(()=>null);

  if(!d){ show("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ Deploy / SCRIPT_URL / ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Anyone)","err"); $tbody.innerHTML=`<tr><td colspan="6"><small>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small></td></tr>`; return; }
  if(!d.ok){ show("‚ùå "+(d.msg||"ADMIN_DENY"),"err"); $tbody.innerHTML=`<tr><td colspan="6"><small>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</small></td></tr>`; return; }

  const query = $q.value.trim();
  let items = Array.isArray(d.items) ? d.items : [];
  if(query){
    items = items.filter(x => String(x.phone||"").includes(query));
  }

  if(!items.length){
    $tbody.innerHTML = `<tr><td colspan="6"><small>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small></td></tr>`;
    show("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ","ok");
    return;
  }

  $tbody.innerHTML = items.map(x=>{
    const row = Number(x.row||0);
    const created = x.created_at ? new Date(x.created_at).toLocaleString() : "-";
    const phone = esc(x.phone||"");
    const status = String(x.status||"").toUpperCase();
    const code = esc(x.promo_code||"");

    const btnApprove = `<button class="btnGood" type="button" data-act="admin_approve" data-row="${row}">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`;
    const btnReject  = `<button class="btnMain" type="button" data-act="admin_reject" data-row="${row}">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>`;
    const btnUsed    = `<button class="btnBlue" type="button" data-act="admin_used" data-row="${row}">USED</button>`;
    const btnClear   = `<button class="btnAlt" type="button" data-act="admin_clear" data-row="${row}">‡∏õ‡∏•‡∏î‡∏ú‡∏π‡∏Å/‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô</button>`;

    return `
      <tr>
        <td><b>${row}</b></td>
        <td>${esc(created)}</td>
        <td><b>${phone}</b></td>
        <td>${pill(status)}</td>
        <td><b>${code || "-"}</b></td>
        <td>
          <div class="actions">
            ${btnApprove}
            ${btnReject}
            ${btnUsed}
            ${btnClear}
          </div>
        </td>
      </tr>
    `;
  }).join("");

  show("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ("+items.length+" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)","ok");
}

async function act(action, row){
  hideMsg();
  let cfg;
  try{ cfg = getCfg(); }catch(e){ show(e.message,"err"); return; }

  show("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...");

  const d = await jsonp(cfg.url, {
    action,
    admin_token: cfg.token,
    row: String(row)
  }).catch(()=>null);

  if(!d){ show("‚ùå ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ SCRIPT_URL/Deploy)","err"); return; }
  if(!d.ok){ show("‚ùå "+(d.msg||"‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),"err"); return; }

  show("‚úÖ "+(d.msg||"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),"ok");
  await loadList();
}

async function addCodes(){
  hideMsg();
  let cfg;
  try{ cfg = getCfg(); }catch(e){ show(e.message,"err"); return; }

  const text = $codes.value.trim();
  if(!text){ show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô","err"); return; }

  show("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î...");
  const d = await jsonp(cfg.url, {
    action:"admin_add_codes",
    admin_token: cfg.token,
    codes: text
  }).catch(()=>null);

  if(!d){ show("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","err"); return; }
  if(!d.ok){ show("‚ùå "+(d.msg||"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),"err"); return; }

  show("‚úÖ "+(d.msg||"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),"ok");
  $codes.value = "";
}

$btnSave.onclick = saveLocal;
$btnLoad.onclick = loadList;
$btnRefresh.onclick = loadList;
$btnAddCodes.onclick = addCodes;

$tbody.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("button[data-act]");
  if(!btn) return;
  const action = btn.getAttribute("data-act");
  const row = Number(btn.getAttribute("data-row")||0);
  if(!row) return;
  act(action,row);
});
</script>
</body>
</html>
