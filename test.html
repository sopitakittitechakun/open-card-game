<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå)</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{--bg:#0b0b0b;--line:rgba(255,255,255,.12);--txt:#fff;--muted:#cfcfcf;--accent:#ff2b2b;--accent2:#b80000}
*{box-sizing:border-box}
body{margin:0;padding:18px;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;background:radial-gradient(900px 500px at 50% -10%, rgba(255,60,60,.15), transparent 60%), var(--bg);color:var(--txt)}
.card{max-width:1100px;margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.6)}
h1{margin:0 0 10px;font-size:18px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
input,select,textarea{background:#0f0f0f;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:#fff;font-size:14px}
textarea{width:100%;min-height:110px;resize:vertical}
.btn{padding:10px 12px;border:0;border-radius:12px;cursor:pointer;font-weight:900;color:#fff}
.btnMain{background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btnAlt{background:#2a2a2a}
.btnOk{background:linear-gradient(135deg,#22c55e,#16a34a)}
.small{color:var(--muted);font-size:12px;line-height:1.6}
.hr{height:1px;background:var(--line);margin:12px 0}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th{color:#ddd;font-size:12px;text-align:left;padding:0 10px}
tr{background:rgba(0,0,0,.25)}
td{padding:10px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
td:first-child{border-left:1px solid rgba(255,255,255,.06);border-radius:12px 0 0 12px}
td:last-child{border-right:1px solid rgba(255,255,255,.06);border-radius:0 12px 12px 0}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid rgba(255,255,255,.15)}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:900;letter-spacing:.5px}
.msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);white-space:pre-line;display:none;line-height:1.6}
</style>
</head>
<body>
<div class="card">
  <h1>üõ°Ô∏è ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô RR365 (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ Code.gs)</h1>

  <div class="row">
    <div style="flex:2;min-width:320px">
      <div class="small">SPREADSHEET_ID (‡πÑ‡∏≠‡∏î‡∏µ‡∏ä‡∏µ‡∏ó)</div>
      <input id="ssid" style="width:100%" placeholder="1vU5sgYKY2f0CnVv9YNnG-6OrqzLnn-t_iSLUls0MefU">
    </div>
    <div style="min-width:220px">
      <div class="small">‡πÅ‡∏ó‡πá‡∏ö participants</div>
      <input id="tabP" value="participants">
    </div>
    <div style="min-width:220px">
      <div class="small">‡πÅ‡∏ó‡πá‡∏ö codes</div>
      <input id="tabC" value="codes">
    </div>
    <button class="btn btnMain" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="btn btnAlt" id="btnLoad">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <div class="small">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
      <select id="status">
        <option value="PENDING" selected>PENDING</option>
        <option value="APPROVED">APPROVED</option>
        <option value="REJECTED">REJECTED</option>
        <option value="USED">USED</option>
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>
    </div>
    <div style="flex:1;min-width:240px">
      <div class="small">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</div>
      <input id="q" style="width:100%" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0611 ‡∏´‡∏£‡∏∑‡∏≠ 9999">
    </div>
    <button class="btn btnAlt" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <div id="msg" class="msg"></div>
  <div class="hr"></div>

  <div class="small">
    ‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ ‚Äú‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‚Äù ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå<br>
    ‚ùó ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/USED ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÉ‡∏ô Google Sheet ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π üõ°Ô∏è RR365 ADMIN (‡∏ï‡∏≤‡∏°‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏°) :contentReference[oaicite:3]{index=3}
  </div>

  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÇ‡∏Ñ‡πâ‡∏î</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="hr"></div>
  <div class="small">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡πá‡∏ö codes (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡πÇ‡∏Ñ‡πâ‡∏î)</div>
  <textarea id="codes" placeholder="RR1234&#10;RR5678&#10;RR9999"></textarea>
  <div class="row" style="margin-top:10px">
    <button class="btn btnOk" id="btnAdd">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
    <div class="small" style="flex:1">* ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡∏ó/‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Apps Script Bridge (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</div>
  </div>
</div>

<script>
/*
  IMPORTANT:
  - ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Google Sheet ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ï‡∏£‡∏á‡πÜ ‚Äú‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏∂‡πà‡∏á‡∏Å‡∏≤‡∏£ publish/‡πÅ‡∏ä‡∏£‡πå‚Äù ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
  - ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° admin API ‡πÉ‡∏ô Code.gs (‡πÅ‡∏ï‡πà‡∏ô‡∏±‡πà‡∏ô‡∏Ñ‡∏∑‡∏≠ ‚Äú‡πÅ‡∏ï‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‚Äù)
  - ‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏≠: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ Code.gs
*/
const LS="RR365_ADMIN_NO_TOUCH_V1";
const $=id=>document.getElementById(id);

const $ssid=$("ssid"), $tabP=$("tabP"), $tabC=$("tabC");
const $status=$("status"), $q=$("q");
const $tbody=$("tbody"), $msg=$("msg"), $codes=$("codes");

function show(t){ $msg.style.display="block"; $msg.textContent=t; }
function hide(){ $msg.style.display="none"; $msg.textContent=""; }

function save(){
  localStorage.setItem(LS, JSON.stringify({
    ssid:$ssid.value.trim(), tabP:$tabP.value.trim(), tabC:$tabC.value.trim()
  }));
  show("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
}
function load(){
  const raw=localStorage.getItem(LS);
  if(!raw) return;
  try{
    const o=JSON.parse(raw);
    if(o.ssid) $ssid.value=o.ssid;
    if(o.tabP) $tabP.value=o.tabP;
    if(o.tabC) $tabC.value=o.tabC;
  }catch(_){}
}
load();

function sheetCSVUrl(ssid, tabName){
  // ‡∏ï‡πâ‡∏≠‡∏á publish sheet ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(ssid)}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tabName)}`;
}

// CSV parser ‡πÄ‡∏ö‡∏≤‡πÜ
function parseCSV(text){
  const rows=[]; let row=[], cur="", inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], nx=text[i+1];
    if(inQ){
      if(ch===`"` && nx===`"`){ cur+=`"`; i++; }
      else if(ch===`"`){ inQ=false; }
      else cur+=ch;
    }else{
      if(ch===`"`){ inQ=true; }
      else if(ch===`,"){ row.push(cur); cur=""; }
      else if(ch===`\n`){ row.push(cur); rows.push(row); row=[]; cur=""; }
      else if(ch===`\r`){ /* ignore */ }
      else cur+=ch;
    }
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function mask(p){
  p=String(p||""); if(p.length<10) return "0XXXXXXXXX";
  return p.slice(0,3)+"XXXX"+p.slice(-3);
}

async function loadList(){
  hide(); $tbody.innerHTML="";
  const ssid=$ssid.value.trim(), tabP=$tabP.value.trim();
  if(!ssid||!tabP){ show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SPREADSHEET_ID ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö participants"); return; }
  show("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");

  const url=sheetCSVUrl(ssid, tabP);
  const text=await fetch(url).then(r=>r.ok?r.text():Promise.reject()).catch(()=>null);
  if(!text){ show("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡πâ‡∏≠‡∏á publish/‡πÅ‡∏ä‡∏£‡πå‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ"); return; }

  const rows=parseCSV(text);
  if(rows.length<2){ show("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }

  const header=rows[0].map(s=>s.trim());
  const idx = (name)=> header.findIndex(h=>h===name);
  const iCreated=idx("created_at"), iPhone=idx("phone"), iStatus=idx("status"), iPromo=idx("promo_code"), iNote=idx("note");

  let data=rows.slice(1).map(r=>({
    created_at:r[iCreated]||"",
    phone:(r[iPhone]||"").replace(/^'/,"").trim(),
    status:(r[iStatus]||"").trim(),
    promo:(r[iPromo]||"").trim(),
    note:(r[iNote]||"").trim()
  })).filter(x=>x.phone);

  const s=$status.value.trim();
  if(s) data=data.filter(x=>x.status===s);
  const q=$q.value.trim();
  if(q) data=data.filter(x=>x.phone.includes(q));

  if(!data.length){ show("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ"); return; }
  hide();

  $tbody.innerHTML=data.map((x,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${x.created_at||"-"}</td>
      <td title="${x.phone}">${mask(x.phone)}</td>
      <td><span class="badge">${x.status||"-"}</span></td>
      <td><span class="code">${x.promo||"-"}</span></td>
      <td>${x.note||""}</td>
    </tr>
  `).join("");
}

async function addCodes(){
  // NOTE: ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô UI ‡πÄ‡∏â‡∏¢‡πÜ ‚Äî ‡∏Å‡∏≤‡∏£ ‚Äú‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‚Äù ‡∏•‡∏á‡∏ä‡∏µ‡∏ó‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ï‡∏£‡∏á‡πÜ ‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
  show("‚ùó‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ\n‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡πà‡∏≤‡∏ô Google Sheet ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° admin API ‡πÉ‡∏ô Code.gs");
}

$("btnSave").onclick=save;
$("btnLoad").onclick=()=>{ load(); loadList(); };
$("btnRefresh").onclick=loadList;
$("btnAdd").onclick=addCodes;
</script>
</body>
</html>
